<!DOCTYPE html><html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>おまつり奉行</title>
<style type="text/css">
html {
  margin: 0;
  padding: 0;
  width: 100vw;
  height: 100vh;
  font-size: 4vw;
}

body {
  font-size: 1rem;
}

div {
  font-size: 1rem;
  margin: 0px;
  padding: 0px;
  box-sizing: border-box;
  display: flex;
  display: -webkit-flex;
}

div.table {
  width: 100%;
  flex-direction: column;
}
div.tr {
  width: 100%;
  padding: 0.25rem;
  flex-direction: row;
}

h1 {
  font-size: 1.6rem;
}

.error {
  color: red;
}
.flex {
  display: flex;
  display: -webkit-flex;
}
.hide {
  display: none;
}

button, input[type="button"] {
  font-size: 1rem;
}

/* == ヘッダ ============================================= */
header {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 2rem;
  display: -webkit-flex;
  display: flex;
  -webkit-flex-direction: row;
  flex-direction: row;
  -webkit-justify-content: space-between;
  justify-content: space-between;
  margin-bottom: 1rem;
  background-color: #a0c238;
}
header .icon, .menuIcon {
  margin: 0.2rem;
  width: 1.6rem;
  height: 1.6rem;
}
header img {
  width: 100%;
  height: 100%;
}
header .title {
  margin: auto;
  width: calc(100% - 4rem);
  font-size: 1.2rem;
}

/* == メニュー =========================================== */
header .menu img {
  margin: 0.3rem;
  max-width: 1.4rem;
  max-height: 1.4rem;
}

nav {
  z-index: 10;
  background-color: rgba(0,0,0,.5);
  position: absolute;
  top: 2rem;
  right: 0;
  width: 15rem;
  height: calc(100% - 2rem);
}
nav ol {
  padding: 0;
  margin: 0;
}
nav li {
  list-style-type: none;
  margin: 0.75rem;
  padding-right: 0.8rem;
  border: solid 3px #888;
  width: calc(15rem - 2.5rem - 6px);
  color: white;
  text-align: right;
  transition: .5s;
}

/* == メイン ============================================= */
#main {
  position: absolute;
  margin: 0px;
  top: 2.5rem;
  left: 0px;
  width: 100%;
  height: calc(100% - 2.5rem);
  border: none;
}

div.screen {
  width: 100%;
  flex-direction: column;
}

/* :: page "menu" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "menu" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "authorize" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "authorize" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "messageBoard" CSS section start. :::::::::::::::::::::::::::::::::::::: */
.messageBoard div {
  flex-direction: column;
  width: 100%;
}

.messageBoard .postButton {
  margin: 0px 1rem;
  width: calc(100% - 2rem);
}

.messageBoard .postArea {
  margin: 1rem;
  padding: 0.5rem;
  width: calc(100% - 2rem);
  background-color: #deecc6;
}
.messageBoard .postArea div {
  margin-bottom: 0.5rem;
}
.messageBoard .postArea .fromto {
  flex-direction: row;
  padding-right: 1rem;
}
.messageBoard .postArea .fromto label {
  display: block;
  float: left;
  width: 4rem;
}
.messageBoard .postArea .fromto input, select {
  width: 8rem;
}
.messageBoard .postArea textarea {
  width: auto;
  height: 4rem;
}

.messageBoard .broadArea {
  padding: 0 1rem;
  margin-top: 1rem;
  height: 100%;
  overflow: auto;
}
.messageBoard .broadArea p {
  width: 100%;
  margin-top: 0;
  margin-bottom: 0.5rem;
}
.messageBoard .broadArea p.date {
  width: calc(100% - 1rem);
  padding-left: 1rem;
  background-color: forestgreen;
  color: white;  
}
.messageBoard .broadArea p.title {
  margin-bottom: 0.2rem;
  background-color: #a0c238;
  font-size: 0.8rem;
}
/* :: page "messageBoard" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "reception" CSS section start. :::::::::::::::::::::::::::::::::::::: */
.entryNo {
  flex-direction: column;
  flex-wrap: nowrap;
}
.entryNo input {
  font-size: 1rem;
  width: 4rem;
  margin-left: 2rem;
}

.paperForm {
  flex-direction: column;
}

/* 登録フォーム誘導・紙申請処理ボタン */
.reception > div {
  margin: 1rem 0;
  -webkit-justify-content: space-around;
  justify-content: space-around;  
}
.reception > div:first-child > button {
  width: 40%;
}

/* 受付番号または氏名での検索窓 */
.reception input {
  width: 15rem;
}

/* 該当者検索後の編集画面 */
.wrapper {
  flex-direction: column;
}
.applicant {
  font-size: 1.5rem;
}
.applicant button {
  height: 1.8rem;
  margin-left: auto;
}
.details {
  margin: 1rem 0;
}
.details .th {
  width: 8rem;
}
.details div.tr:nth-child(odd) {
  background-color: #aff;
}
.members .no {
  width: 10%;
}
.members .name {
  width: 40%;
}
.members .status,.fee {
  width: 25%;
}
.members div.tr:nth-child(odd) {
  background-color: #bfb;
}
.members div.tr:last-child {
  -webkit-justify-content: space-between;
  justify-content: space-between;
  margin-top: 1rem;
}
.result {
  flex-direction: column;
}

/* :: page "reception" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "cornerOperation" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "cornerOperation" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "entry" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "entry" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "referState" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "referState" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "information" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* https://pulpxstyle.com/css-button/ */
div.button a {
  text-decoration: none;

  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  /*margin: 0 auto;*/
  margin: 1rem;
  padding: 1em 2em;
  /*width: 300px;*/
  width: calc(100% - 6rem);
  color: #333;
  font-size: 18px;
  font-weight: 700;
  background-color: #ccc;
  transition: 0.3s;
}

div.button a::before {
  content: '';
  position: absolute;
  top: -5px;
  left: -5px;
  width: calc(100% - 4px);
  height: calc(100% - 4px);
  border: 2px solid #3d9ec8;
  transition: 0.2s;
}

div.button a::after {
  content: '';
  width: 5px;
  height: 5px;
  border-top: 3px solid #333333;
  border-right: 3px solid #333333;
  transform: rotate(45deg);
}

div.button a:hover::before {
  top: 0;
  left: 0;
}

div.button a:hover {
  text-decoration: none;
  background-color: #a0c4d3;
}
/* :: page "information" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "enquete" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "enquete" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "system" CSS section start. :::::::::::::::::::::::::::::::::::::: */
div.system div {
  flex-direction: column;
}
/* :: page "system" CSS section end. :::::::::::::::::::::::::::::::::::::::: */

</style>
</head>
<body>
  <header>
    <div class="icon"><img src="img/stamp.png" /></div>
    <div class="title"></div>
    <div class="menuIcon"></div>
  </header>
  <nav>
    <ol>
      <li name="messageBoard">お知らせ</li>
      <li name="reception">受付業務</li>
      <li name="cornerOperation">コーナー運営</li>
      <li name="entry">参加受付</li>
      <li name="referState">予約状況参照</li>
      <li name="information">お役立ち情報</li>
      <li name="enquete">参加者アンケート</li>
      <li name="system">システム設定</li>
    </ol>
  </nav>
  <div id="main">

<div class="screen menu"><!-- :: page "menu" HTML section start. ::::::::::: -->
</div><!-- page "menu" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen authorize"><!-- :: page "authorize" HTML section start. ::::::::::: -->
  <div class="entryNo">
    <p>受付番号を入力してください</p>
    <div>
      <input type="text" />
      <input type="button" value="送信" />,\n
    </div>
    <div class="message"></div>
  </div>

  <div class="passCode hide">
    <p>確認のメールを送信しました。記載されているパスコード(数字6桁)を入力してください。<br>
    ※まれに迷惑メールと判定される場合があります。メールが来ない場合、そちらもご確認ください。</p>
    <input type="text" />
    <input type="button" value="送信" />
    <div class="message">※パスコードの有効期限は1時間です</div>
  </div>
</div><!-- page "authorize" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen messageBoard"><!-- :: page "messageBoard" HTML section start. ::::::::::: -->
  <div class="postButton">
    <input type="button" value="投稿する" />
  </div>
  <div class="postArea hide">
    <div class="fromto">
      <div>
        <label>From</label>
        <input type="text" name="from" width="100%"
          placeholder="ハンドルネームを入力"
          onchange="config.handleName=this.value"
        />
      </div>
      <div>
        <label>To</label>
        <select name="to">
          <option value="スタッフ全員">スタッフ全員</option>
          <option value="本部">本部</option>
          <option value="カレー担当">カレー担当</option>
          <option value="校内探検担当">校内探検担当</option>
          <option value="受付担当">受付担当</option>
          <option value="金魚すくい担当">金魚すくい担当</option>
          <option value="射的担当">射的担当</option>
        </select>
      </div>
    </div>
    <div class="message">
      <textarea></textarea>
    </div>
    <div class="submit">
      <input type="button" name="sendMessage" value="送信" />
    </div>
  </div>

  <div class="broadArea"></div>
</div><!-- page "messageBoard" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen reception"><!-- :: page "reception" HTML section start. ::::::::::: -->
  <!-- サブメニュー -->
  <div>
    <button onclick="config.reception.formQR()">登録フォーム誘導</button>
    <button onclick="config.reception.paperForm()">紙申請処理</button>
  </div>

  <!-- 該当者検索 -->
  <div class="inputKey">
    <input type="text" placeholder="&#x1F50D受付番号または氏名読み(最初の数文字)" />
    <button onclick="config.reception.search()">検索</button>
  </div>
  <div class="scanner"></div><!-- QRコードスキャナ -->




</div><!-- page "reception" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen cornerOperation"><!-- :: page "cornerOperation" HTML section start. ::::::::::: -->
</div><!-- page "cornerOperation" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen entry"><!-- :: page "entry" HTML section start. ::::::::::: -->
  <button>参加者の追加・変更・取消</button>
  <h1></h1>
  <div></div>
</div><!-- page "entry" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen referState"><!-- :: page "referState" HTML section start. ::::::::::: -->
  <h1 style="text-align:center">(未実装)</h1>
</div><!-- page "referState" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen information"><!-- :: page "information" HTML section start. ::::::::::: -->
  <div class="button"><a href="../materials/timetable/WBS.html" target="_blank">進行予定</a></div>
  <div class="button"><a href="../materials/map.html" target="_blank">校内案内図</a></div>
  <div class="button"><a href="https://sites.google.com/view/shimokita-oyaji/home/archives/20221001-%E6%A0%A1%E5%BA%AD%E3%83%87%E3%82%A4%E3%82%AD%E3%83%A3%E3%83%B3%E3%83%97" target="_blank">募集要項</a></div>  
</div><!-- page "information" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen enquete"><!-- :: page "enquete" HTML section start. ::::::::::: -->
</div><!-- page "enquete" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen system"><!-- :: page "system" HTML section start. ::::::::::: -->
  <div>
    <h1>定期的処理の停止・再開</h1>
    <input type="button" name="start_stop" value="停止" />
  </div>

  <div>
    <h1>ヘルプ</h1>
    <details><summary>[Android]カメラを使おうとすると「使用できません」と表示される</summary>
      <p>ブラウザにカメラを使用する権限が付与されていない場合に表示されます。対応は以下の通りです(<a href="https://support.google.com/android/answer/9431959?hl=ja" target="_blank">出典</a>)。</p>
      <ol>
        <li>設定 > アプリ > 変更するアプリ(ブラウザ)を選択 > 権限 > カメラ</li>
        <li>「許可しない」から「アプリの使用中のみ許可」または「毎回確認する」に変更</li>
      </ol>
    </details>
  </div>

  <div>
    <h1>おまつり奉行について</h1>
    <p>about OMATSURI-Bugyo</p>
    <p>version: 1.1.0 (Dec.13,2022 released)</p>
    <p>
      author : 
      <a mailto="nakaone.kunihiro@gmail.com">
        <ruby>
          <rb>嶋津　邦浩</rb>
          <rt>2-2ゆうなパパ</rt>
        </ruby>
      </a>
      (Shimazu Kunihiro)
    </p>
    <p>
      License: 
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank">MIT</a>
    </p>
  </div>
</div><!-- page "system" HTML section end. ::::::::::::::::::::::::::::::::: -->

  </div>
</body>
<script src="js/jsQR.js" defer></script><!-- QRコード検出 -->
<script src="js/qrcode.min.js" defer></script><!-- QRコード生成 -->
<script src="js/library.js"></script>
<script type="text/javascript">
const config = {};

// :: page "menu" Script section start. ::::::::::::::::::::::::::::::::::::::
/** class Menu: メニュー表示、制御 */
class Menu {
  constructor(){
    console.log('Menu.constructor start.');
    this.dom = {
      icon: document.querySelector('header .menuIcon'),
      nav: document.querySelector('nav'),
    };
    this.status = true; // メニューが開いている状態ならtrue
    this.closeMenu();

    // メニューの定義
    this.menuObj = {
      messageBoard: {title:'お知らせ', flag:3},
      reception: {title:'受付業務', flag:28},
      cornerOperation: {title:'コーナー運営', flag:32},
      entry: {title:'参加受付', flag:192},
      referState: {title:'予約状況参照', flag:768},
      information: {title:'お役立ち情報', flag:7168},
      enquete: {title:'参加者アンケート', flag:8192},
      system: {title:'システム設定', flag:49152}
    }
    console.log('l.97 config.private.menuFlags='+config.private.menuFlags);
    Object.keys(this.menuObj).forEach(x => {
      // config.private.menuFlagsで指定されたメニューのみ追加
      const li = this.dom.nav.querySelector('li[name="'+x+'"]');
      console.log('l.101 x='+JSON.stringify(x));
      if( (this.menuObj[x].flag & config.private.menuFlags) === 0 ){
        li.classList.add('hide');
      } else {
        li.classList.remove('hide');
        li.addEventListener('click',() => {
          this.closeMenu();
          this.changeScreen();
        });
      }
    });
    this.changeScreen('messageBoard');
    console.log('Menu.constructor end.');
  }

  /** closeMenu: 開いているメニューを閉じる
   * @param {void} - なし
   * @returns {void} なし
   */
  closeMenu = () => {
    console.log('Menu.closeMenu start');
    if( this.status === false ){  // 既に閉じているなら何もしない
      return;
    }
    this.dom.icon.innerHTML = '<img src="img/menu1.svg" />';
    this.dom.icon.querySelector('img').onclick = this.openMenu;
    this.dom.nav.classList.add('hide');
    this.status = false;
    console.log('Menu.closeMenu end');
  }

  /** openMenu: 閉じているメニューを開く
   * @param {void} - なし
   * @returns {void} なし
   */
  openMenu = () => {
    console.log('Menu.openMenu start');
    if( this.status === true ){   // 既に開いているなら何もしない
      return;
    }
    this.dom.icon.innerHTML = '<img src="img/menu2.svg" />';
    this.dom.icon.querySelector('img').onclick = this.closeMenu;
    this.dom.nav.classList.remove('hide');
    this.status = true;
    console.log('Menu.openMenu end');
  }

  /** changeScreen: 指定画面への変更
   * @param {string} screenId - this.menuObjのメンバ名
   * @returns {void} なし
   */
  changeScreen = (screenId) => {
    // メニューからクリックされた場合、name属性をscreenIdとする
    if( !screenId ){
      screenId = window.event.target.attributes.name.value;
    }
    console.log('Menu.changeScreen screenId='+screenId);

    // タイトルの表示
    document.querySelector('header .title').innerText = this.menuObj[screenId].title;

    // main直下の全DIVに対して、指定screenIdなら表示・それ以外は非表示
    document.querySelectorAll('#main .screen').forEach(x => {
      if( x.classList.contains(screenId) ){
        x.classList.remove('hide');
      } else {
        x.classList.add('hide');
      }
    });
  }

}

// :: page "menu" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "authorize" Script section start. ::::::::::::::::::::::::::::::::::::::
/** class Auth: クライアント側の認証 */
class Auth {
  /** constructor: 認証画面の生成
   * @param {function} callback - 認証成功後の処理。既定値：何もしない
   * @returns {void} なし
   */
  constructor(callback=()=>{}){
    this.callback = callback; // getPassCode終了後に呼び出し
    this.dom = {
      entryNo: document.querySelector('.authorize .entryNo'),
      passCode: document.querySelector('.authorize .passCode'),
    }
    this.dom.entryNo.querySelector('input[type="button"]').onclick = this.getEntryNo;
    this.dom.passCode.querySelector('input[type="button"]').onclick = this.getPassCode;

    // デバッグ時はテスト用configセット後、後処理を実行
    if( config.debugMode > 0 ){
      this.setTestData(config.debugMode);
      this.callback();
    }
  }

  /** getEntryNo: 受付番号を入力、認証局に問合せ
   * @param {void} - なし
   * @returns {void} - なし
   */
  getEntryNo = () => {
    console.log('Auth.getEntryNo start.');

    // 受付番号のボタンを不活性化
    this.dom.entryNo.querySelector('input[type="button"]').disabled = 'disabled';
    // メッセージ設定
    this.dom.entryNo.querySelector('.message').innerHTML = '<p>暫くお待ちください...</p>';

    const inputValue = this.dom.entryNo.querySelector('input[type="text"]').value;
    // 受付番号が適切かチェック、不適切なら処理中断
    if( !inputValue.match(/^[0-9]{1,4}$/) ){
      alert("不適切な受付番号です");
      // 入力欄をクリア
      this.dom.entryNo.querySelector('input[type="text"]').value = '';
      // 受付番号のボタンを活性化
      this.dom.entryNo.querySelector('input[type="button"]').disabled = null;
      return;
    }

    config.entryNo = Number(inputValue);
    config.entryStr = ('000'+config.entryNo).slice(-4);
    const res = fetchGAS({
      to       : 'Auth',
      func     : 'auth1A',
      data     : config.entryNo,
      callback : (response) => {
        console.log('getEntryNo response = '+JSON.stringify(response));
        if( response.isErr ){
          const d = this.dom.entryNo.querySelector('.message');
          d.innerHTML = '';
          for( let i=0 ; i<response.faild.length ; i++ ){
            d.innerHTML = d.innerHTML + '<p class="error">'
              + response.faild[i].recipient + ' : '
              + response.faild[i].message + '</p>';
          }
        } else {
          // 受付番号入力欄を隠蔽
          this.dom.entryNo.classList.add('hide');
          // パスコード入力画面を開く
          this.dom.passCode.classList.remove('hide');
        }
      },
    });
    console.log('Auth.getEntryNo end. res='+JSON.stringify(res));
  }

  /** getPassCode: パスコード入力
   * @param {void} - なし
   * @returns {void} なし
   */
  getPassCode = () => {
    console.log('Auth.getPassCode start');

    // パスコードのボタンを不活性化
    this.dom.passCode.querySelector('input[type="button"]').disabled = 'disabled';

    // パスコードの形式が適切かチェック、	不適切なら処理中断
    const inputValue = this.dom.passCode.querySelector('input[type="text"]').value;
    if( !inputValue.match(/^[0-9]{6}$/) ){
      alert("不適切なパスコードです");
      // 入力欄をクリア
      this.dom.passCode.querySelector('input[type="text"]').value = '';
      // パスコードのボタンを活性化
      this.dom.passCode.querySelector('input[type="button"]').disabled = null;
      return;
    }

    const rv = fetchGAS({
      to: 'Auth',
      func: 'auth2A',
      data: {entryNo:config.entryNo, passCode:inputValue},
      callback: (response) => {
        console.log('getPassCode response = '+JSON.stringify(response));
        if( response.isErr ){
          this.dom.passCode.querySelector('.message').innerHTML
            = '<p class="error">' + response.message + '</p>';
        } else {
          // configの内容を更新
          for( let x in response.config ){
            if( whichType(response.config[x]) === 'Object' ){
              if( config[x] === undefined ){
                config[x] = {};
              }
              for( let y in response.config[x] ){
                config[x][y] = response.config[x][y];
              }
            } else {
              config[x] = response.config[x];
            }
          }
          this.dom.main.innerHTML = ''; // 主表示域をクリア
          console.log('config='+JSON.stringify(config));
          // 後処理を呼び出す
          this.callback(response);
        }
      }
    });

    console.log('Auth.getPassCode end');
  }

  /** setTestData: debugModeに従ってconfigに値を設定
   * @param {number} debugMode - 0:通常, 1:スタッフ, 2:参加者
   * @returns {void} なし
   */
  setTestData = (debugMode) => {
    console.log('Auth.setTestData start. debugMode='+debugMode);

    const testdata = {

      // config.jsonのコピー。適宜最新のものに書き換えすること。
      "Auth": {   // 認証局
        "level": 1,
        // 認証局は誰でもアクセス可なので、key は設定しない
        "key": "",  // undefinedにならないよう設定するダミー
        "url": "https://script.google.com/macros/s/AKfycbzjsxwmNmR9TV2wswNuUVZDOUIOYVGNGiA02hh74_BwNTzArExR21wVPYFOSLdBNe67BQ/exec"
      },
      "Broad": {  // 放送局
        "level": 2,
        "key": "xGq8kdob7NQXvCG3Jbcil9K-q9HIgJgUO727BfptbUIZXvFX05uJB0CSZHVMb",
        "url": "https://script.google.com/macros/s/AKfycbwUDcopeh6yAFR9_EAb5uMPVMBUZGkROOOgcttKyhy_PS1jGMakxO4lRGUtPVDLfNLdZQ/exec"
      },
      "Reserve": { // 予約局
        "level": 4
      },
      "Master": { // 管理局
        "level": 8,
        "key": "_WGbHipKdOeuFydHpbz2yzjBmnFNqHYuhAvyMy1QcX5BQgyLl",
        "url": "https://script.google.com/macros/s/AKfycbzuKbQ053i_x6RrkkIqBwNcmvRg4tEQCOFvIPjDlVtajDy7i4LzkVS3YtyI2LhpjkJ32w/exec",
        "validTime": 3600000  // パスコードの有効時間。ミリ秒
      },
      "Post": {   // 郵便局
        "level": 16,
        "key": "hZ8QEXviiBdU_PfGlZrnIuHODkb6-vY8wx4_azvBd2vbOEEAS3xxI",
        "url": "https://script.google.com/macros/s/AKfycbw1BZqob_P6SnIW3dDQrzDTZtt0Z9de60wiHhw94k7gbLFYdThmHyUeS8ATmqd2z_etbw/exec"
      },
      "Agency": {  // 資源局
        "level": 32,
        "key": "IptLc8AbphZ8QEXviiBdU_PfGvCG3Jbcil9lZrnIuHO",
        "url": "https://script.google.com/macros/s/AKfycbyNBetqxnZoHQee3vrApYJUXIyty2YdeuQfPpZVKgOko8IwJU8gKjCm0G4lu_qF-vo/exec",
        "overhead": 140 // ログを書き込む際に発生する想定オーバーヘッド。ミリ秒
      },
      "public": {    // 公開情報
        "level": 65535,
        "interval": 30000, // 定期配信の間隔。ミリ秒
        "Administrator":  // システム管理者のメールアドレス
          "shimokitasho.oyaji@gmail.com",
        "FormId":
          "1hnQLsY3lRh0gQMGfXoJJqAL_yBpKR6T0h2RFRc8tUEA",
        "FormURL":  // 参加申請受付フォーム。当日参加を誘導するのに使用
          "https://docs.google.com/forms/d/e/1FAIpQLSfIJ4IFsBI5pPXsLz2jlTBczzIn8QZQL4r6QHqxZmSeDOhwUA/viewform",
        "SiteURL": // イベント案内サイト。実施・募集要領他を掲載したサイト
          "https://sites.google.com/view/shimokita-oyaji/home/archives/20221001-%E6%A0%A1%E5%BA%AD%E3%83%87%E3%82%A4%E3%82%AD%E3%83%A3%E3%83%B3%E3%83%97",
        "MapURL": // イベント会場マップ。GitHubのmaterialsディレクトリに保持
          "materials/map.html",
        "TableURL": // タイムテーブル(進行予定表)。GitHubのmaterialsに保持
          "materials/timetable/WBS.html",
        "EnqueteURL":  // 参加者アンケート
          "https://docs.google.com/forms/d/16r3luYQRiLVmI9xqaD4FuaSlUqTRGvI8nAGrjGcg8lc/viewform"
      },

      // Agentは資源局からコピー
      "Agent": {
        key:"pSp2*ZR_S/GXr9C5",
        url:"https://script.google.com/macros/s/AKfycbyJDT4rTHPPY6BP2DW4LVZLR3ozzb13ROJ9zvuLrb7cM2V7AaYTLlDICYwKnWhSC-mD/exec"
      },

      // Privateは開発モード画面からコピー。または管理局のシートから。
      "staff":{
        "タイムスタンプ":"2022-10-09T04:34:42.211Z",
        "メールアドレス":"shimokitasho.oyaji@gmail.com",
        "申請者氏名":"奥田　美香",
        "申請者氏名読み":"オクダ　ミカ",
        "申請者はイベントに参加しますか？":"参加する",
        "参加者①氏名":"太郎",
        "参加者①氏名読み":"タロウ",
        "参加者①所属":"未就学児",
        "参加者②氏名":"二郎",
        "参加者②氏名読み":"ジロウ",
        "参加者②所属":"1年",
        "参加者③氏名":"",
        "参加者③氏名読み":"",
        "参加者③所属":"",
        "緊急連絡先":"",
        "引取者氏名":"",
        "備考":"",
        "キャンセル":"",
        "cancel":"1",
        "participate00":"1",
        "entryNo":"1",
        "editURL":"https://docs.google.com/forms/d/e/1FAIpQLSfIJ4IFsBI5pPXsLz2jlTBczzIn8QZQL4r6QHqxZmSeDOhwUA/viewform?edit2=2_ABaOnufCYALGfSCCaKbN4LDLlq9n6oTS8MfbMXvMVGeqH9hcsqj47n1z3eUW-muVZIhFFjg",
        "application":"",
        "PIC":"",
        "passCode":"27467",
        "passTime":"2022-12-06T06:06:51.655Z",
        "manualMF":"57119",
        "menuFlags":"57119",
        "manualAL":"14",
        "AuthLevel":"14",
        "name00":"奥田　美香",
        "yomi00":"オクダ　ミカ",
        "category00":"保護者",
        "status00":"",
        "fee00":"",
        "name01":"太郎",
        "yomi01":"タロウ",
        "category01":"未就学児",
        "status01":"",
        "fee01":"",
        "name02":"二郎",
        "yomi02":"ジロウ",
        "category02":"1年",
        "status02":"",
        "fee02":"",
        "name03":"",
        "yomi03":"",
        "category03":"",
        "status03":"",
        "fee03":""
      },
      "participant":{
        "タイムスタンプ":"2022-10-09T04:39:20.911Z",
        "メールアドレス":"shimokitasho.oyaji@gmail.com",
        "申請者氏名":"榎田　道子",
        "申請者氏名読み":"エノキダ　ミチコ",
        "申請者はイベントに参加しますか？":"参加する",
        "参加者①氏名":"",
        "参加者①氏名読み":"",
        "参加者①所属":"",
        "参加者②氏名":"",
        "参加者②氏名読み":"",
        "参加者②所属":"",
        "参加者③氏名":"",
        "参加者③氏名読み":"",
        "参加者③所属":"",
        "緊急連絡先":"",
        "引取者氏名":"",
        "備考":"",
        "キャンセル":"",
        "cancel":"1",
        "participate00":"1",
        "entryNo":"2",
        "editURL":"https://docs.google.com/forms/d/e/1FAIpQLSfIJ4IFsBI5pPXsLz2jlTBczzIn8QZQL4r6QHqxZmSeDOhwUA/viewform?edit2=2_ABaOnucIuwg3VQQ89wjGMjOrBzL9Ko6Yd_-VRLBvabY6pcLfvOC1MGlrA29XPym2rtomwwQ",
        "application":"",
        "PIC":"",
        "passCode":"469555",
        "passTime":"2022-12-06T06:09:22.880Z",
        "manualMF":"",
        "menuFlags":"32449",
        "manualAL":"",
        "AuthLevel":"4",
        "name00":"榎田　道子",
        "yomi00":"エノキダ　ミチコ",
        "category00":"保護者",
        "status00":"",
        "fee00":"",
        "name01":"",
        "yomi01":"",
        "category01":"",
        "status01":"",
        "fee01":"",
        "name02":"",
        "yomi02":"",
        "category02":"",
        "status02":"",
        "fee02":"",
        "name03":"",
        "yomi03":"",
        "category03":"",
        "status03":"",
        "fee03":""
      },

    };

    // スタッフ・参加者共通パラメータ
    const common = {
      "Auth":{"url":testdata.Auth.url},
      "Reserve":{"level":4},
      "public":testdata.public,
      "Agent":testdata.Agent
    }

    // スタッフ・参加者それぞれの特有パラメータ
    const peculiar = debugMode === 1 ? {
      "entryNo":1,
      "entryStr":"0001",
      "private":testdata.staff,
      "Broad":{"level":2,"key":testdata.Broad.key,"url":testdata.Broad.url},
      "Master":{"level":8,"key":testdata.Master.key,"url":testdata.Master.url,"validTime":3600000},
    } : {
      "entryNo":2,
      "entryStr":"0002",
      "private":testdata.participant,
    }

    // configに値をセット
    Object.keys(common).forEach(x => {config[x] = common[x];});
    Object.keys(peculiar).forEach(x => {config[x] = peculiar[x];});

    console.log('Auth.setTestData end.',config);
  }

}
// :: page "authorize" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "messageBoard" Script section start. ::::::::::::::::::::::::::::::::::::::
/** messageBoard: お知らせへの投稿、配信 */
class messageBoard {
  
  /** constructor: お知らせ画面の設定 */
  constructor(){
    this.dom = {
      title: document.querySelector('header .title'),
      main: document.querySelector('.messageBoard'),
      postArea: document.querySelector('.messageBoard .postArea'),
      postButton: document.querySelector('.messageBoard .postButton input'),
      broadArea: document.querySelector('.messageBoard .broadArea'),
    };
    this.posts = [];
    this.lastUpdate = getJPDateTime('1901/01/01');
    this.startTime = new Date();
    this.intervalId = null;

    // 1. 投稿権限がある場合は投稿エリアを表示
    if( (config.private.menuFlags & 2) > 0 ){
      this.dom.postButton.addEventListener('click',() => {
        if( this.dom.postButton.value === '投稿する' ){
          this.dom.postButton.value = '閉じる';
          this.dom.postArea.classList.remove('hide');
        } else {
          this.dom.postButton.value = '投稿する'
          this.dom.postArea.classList.add('hide');
        }
      });
    }

    this.display();

    // 定期更新を開始
    this.start();
  }

  /** display: 掲示板の表示
   * @param {void} - なし
   * @returns {void} なし
   */
  display(){
    this.dom.title.innerText = 'お知らせ';
    // 1.投稿権限がある場合は投稿エリアを表示
    if( (config.private.menuFlags & 2) > 0 ){
      // 二回目以降の投稿ではハンドルネームをセット
      if( config.handleName ){
        this.dom.main.querySelector('input[name="from"]').value = config.handleName;
      }
    }

    // 2.投稿内容の表示
    // 2.1.新規のお知らせが来たら末尾を表示するよう設定
    // https://at.sachi-web.com/blog-entry-1516.html
    const mo = new MutationObserver(() => {
      console.log('mutation detected');
      this.dom.broadArea.scrollTop = this.dom.broadArea.scrollHeight;
    });
    mo.observe(this.dom.broadArea,{
      childList: true,
      attributes: true,
      characterData: true,
      subtree: true,//孫以降のノードの変化も検出
      attributeOldValue: true,//変化前の属性データを記録する
      characterDataOldValue: true,//変化前のテキストノードを記録する
      attributeFilter: [],//配列で記述した属性だけを見張る
    });

    // 2.2.時系列にメッセージを並べ替え
    this.posts.sort((a,b) => a.timestamp < b.timestamp);

    // 2.3.掲示板領域に書き込むHTMLを msg として作成
    let msg = '';
    let lastMesDate = '1900/01/01';  // 投稿日が変わったら日付を表示するよう制御
    const t = '<p class="title">[_time] From:_from　To:_to</p><p>_message</p>';
    for( let i=0 ; i<this.posts.length ; i++ ){
      const dt = new Date(this.posts[i].timestamp);
      if( dt.toLocaleDateString('ja-JP') !== lastMesDate ){
        lastMesDate = dt.toLocaleDateString('ja-JP');
        msg += '<p class="date">' + lastMesDate + '</p>';
      }
      const hms = ('0'+dt.getHours()).slice(-2)
        + ':' + ('0'+dt.getMinutes()).slice(-2)
        + ':' + ('0'+dt.getSeconds()).slice(-2);
      const m = t.replace('_time',hms)
        .replace('_from',this.posts[i].from)
        .replace('_to',this.posts[i].to)
        .replace('_message',this.posts[i].message)
        .replace(/\n/g,'<br>');
      //console.log('m='+m);
      msg += m;
    }
    // 2.4.掲示板領域に書き込み
    const msgEl = this.dom.main.querySelector('div.broadArea');
    msgEl.innerHTML = msg;
    msgEl.scrollIntoView(false);
  }

  /** getMessages: メッセージの受信、掲示板への表示
   * @param {void} - なし
   * @returns {void} なし
   */
  getMessages(){
    console.log('getMessages start.');
    // 現在表示中の画面が「お知らせ」でなければ受信・表示とも行わない
    if( this.dom.title.innerText !== 'お知らせ' ){
      return;
    }

    /* 配信局へ配信要求
    * @param {string}   arg.to       - 受信側のコード名(平文)
    * @param {string}   arg.func     - GAS側で処理分岐の際のキー文字列
    * @param {any}      arg.data     - 処理対象データ
    * @param {function} arg.callback - GAS処理結果を受けた後続処理 */
    fetchGAS({
      to: 'Agent',
      func: 'castMessages',
      data: this.lastUpdate,
      callback: (res) => {
        console.log('getMessages res='+JSON.stringify(res));
        if( !res.isErr ){
          this.posts = this.posts.concat(res.posts);
          const map = res.posts.map(x => new Date(x.timestamp).getTime());
          //console.log('map='+JSON.stringify(map));
          const mapMax = map.reduce((a,b)=>{return Math.max(a,b)},-Infinity);
          //console.log('mapMax='+mapMax);
          this.lastUpdate = new Date(mapMax);
          this.display();
        }
        //console.log('getMessages lastUpdate='+getJPDateTime(this.lastUpdate)
        //  +'\nposts='+JSON.stringify(this.posts));
      }
    });
   
  }

  /** postMessage: メッセージを投稿
   * @param {void} - なし
   * @returns {void} なし
   */
  postMessage(){
    console.log('postMessage start.');
    config.handleName = this.dom.main.querySelector('[name="from"]').value;
    const toEl = this.dom.main.querySelector('[name="to"]');

    fetchGAS({
      to: 'Broad',
      func: 'postMessage',
      data: {
        timestamp: getJPDateTime(),
        from: config.handleName,
        to: toEl.options[toEl.selectedIndex].value,
        message: this.dom.main.querySelector('[name="message"]').value,
      },
      callback: (res) => {
        this.getMessages();  // 掲示板を更新
        console.log('postMessage end. res='+JSON.stringify(res));
      }
    });
  }

  /** start: 定期的処理の開始
   * @param {void} - なし
   * @returns {void} なし
   */
  start(){
    this.getMessages();
    // スリープ時間も含め一定時間毎に実行
    // https://blog-and-destroy.com/28211
    this.intervalId = setInterval(() => {
      if( Date.now() > (this.startTime + config.public.interval - 500) ){
        this.getMessages();
        this.startTime = Date.now();
      }
    },config.public.interval);
    console.log('Broad.start. interval=' + config.public.interval);
  }

  /** stop: 定期的処理の停止
   * @param {void} - なし
   * @returns {void} なし
   */
  stop(){
    clearInterval(this.intervalId);
    this.intervalId = null;
    console.log('Broad.end');
  }
}
// :: page "messageBoard" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "reception" Script section start. ::::::::::::::::::::::::::::::::::::::
class Reception {

  constructor(){
    this.dom = {
      main: document.querySelector('.reception'),
      title: document.querySelector('header .title'),
      scanner: document.querySelector('.reception .scanner'),
    };
    // スキャナのセットアップ
    this.scanner = new webScanner({
      /* @param {object} arg.parent - 親要素
      * @param {number} arg.interval - 動画状態で撮像、読み込めなかった場合の時間間隔
      * @param {object} arg.RegExp - QRコードスキャン時、内容が適切か判断
      * @param {boolean} arg.alert - 読み込み完了時に内容をalert表示するか */
      parent: this.dom.main.querySelector('.scanner'),
      interval: 0.25,
    });
  }

  /** display: 受付業務画面の表示
   * @param {void} - なし
   * @returns {void} なし
   * <h2>Tips: 動的要素へのイベント定義はonclickで</h2>
   * 当初innerHTML書き換え後にaddEventListenerしていたが、Broad.displayで拾ってしまいreception.jsで定義している関数が呼び出されなかった。<br>
   * これはBroad側でも動的要素を使用しているためdocumentに対してaddEventListenerを先に定義していたため。<br>
   * 動的要素はタグ内でonclickを定義するようにすれば回避可能。
   */
  display(){
    this.scanner.scanQR((code)=>{  // QRコード読込後の処理
      console.log('scanned => '+code);
      this.searchKey(code);
    },{
      RegExp: /^[0-9]+$/,
      alert: true
    });
  }

  /** formQR: 未申請者へ申請フォームのURLをQRコードで表示
   * @param {void} - なし
   * @returns {void} なし
   */
  formQR(){
    console.log('formQR clicked.');
    this.dom.main.innerHTML = `
    <p>スマホをお持ちの場合、以下のフォームから申請をお願いします。</p>
    <div class="qrcode"></div>
    <button name="display">受付業務に戻る</button>
    `;
    let qrcode = new QRCode(this.dom.main.querySelector('div.qrcode'),{
      text: config.public.FormURL,
      width: 300,
      height: 300,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    })
    document.addEventListener('click',(e)=>{
      switch( e.target.name ){
        case 'display':
          this.display();
          break;
      }
    });
  }

  /** paperForm: 紙媒体での申請処理
   * @param {void} - なし
   * @returns {void} なし
   */
  paperForm(){
    console.log('paperForm clicked.');
    this.dom.title = '用紙による申請登録';
    this.dom.main.innerHTML = '';
    let o = genChild({class:'paperForm', children:[
      {tag:'p', text:'申込者の属性を入力してください'},
      {tag:'table', children:[
        {tag:'tr', children:[
          {tag:'th', text:'No'},
          {tag:'th', text:'属性'}
        ]},
      ]},
      {tag:'button', text:'次へ', onclick:'config.reception.paperForm2()'}
    ]});
    if( o.append ){
      this.dom.main.appendChild(o.result);
    }
    ['①','②','③','④','⑤'].forEach(x => {
      o = genChild({tag:'tr', children:[
        {tag:'td', text:x},
        {tag:'td', children:[
          {tag:'select', opt:['未就学児','小1','小2','小3','小4','小5','小6','卒業生','保護者']}
        ]}
      ]});
      console.log('l.104',o);
      if( o.append ){
        this.dom.main.querySelector('.paperForm table').appendChild(o.result);
      }
    });
    /*
      {tag:'p', text:'属性別人数を入力してください'},
    ['未就学児','小1','小2','小3','小4','小5','小6','卒業生','保護者'].forEach(x => {
      o = genChild({tag:'tr', children:[
        {tag:'td', variable:x},
        {tag:'td', children:[
          {tag:'select', opt:['0人','1人','2人','3人','4人','5人']}
        ]}
      ]});
      if( o.append ){
        this.dom.main.querySelector('table'),appendChild(o.result);
      }
    });

    this.dom.main.innerHTML = `
    <h1>(未実装)</h1>
    <button name="display">受付業務に戻る</button>
    `;
    document.addEventListener('click',(e)=>{
      switch( e.target.name ){
        case 'display':
          this.display();
          break;
      }
    });
    */
  }

  /** searchKey: 検索キー(受付番号または氏名の一部)で検索
   * @param {string|undefined} - 検索キーとなる受付番号または氏名の一部
   * @returns {object} 検索結果のオブジェクト
   * <ul>
   * <li>isErr {boolean} - エラーならtrue
   * <li>message {string} - エラーの場合はメッセージ。正常終了ならundefined
   * <li>result {object[]} - 検索キーにマッチした申込の配列。[{項目名:値,..},{..},..]形式
   * </ul>
  */
  searchKey(arg=''){
    console.log('reception.search start. arg='+JSON.stringify(arg));
    this.dom.title.innerText = '該当者の検索';

    this.dom.main.innerHTML = '<img src="img/loading.gif" />';

    /* fetchGAS
    * @param {object}   arg          - 引数
    * @param {string}   arg.to       - 受信側のコード名(平文)
    * @param {string}   arg.func     - GAS側で処理分岐の際のキー文字列
    * @param {any}      arg.data     - 処理対象データ
    * @param {function} arg.callback - GAS処理結果を受けた後続処理 */
    fetchGAS({
      to: 'Master',
      func: 'candidates',
      data: arg.length > 0 ? arg : this.dom.keyWordArea.value,
      callback: (res => {
        if( res.isErr ){
          this.dom.main.innerHTML = '<h1 class="error">' + res.message + '</h1>';
          return;
        } else {
          if( res.result.length === 0 ){
            alert("該当する参加者は存在しませんでした");
            this.display();
          } else if( res.result.length > 1){
            this.selectParticipant(res.result);  // 該当が複数件なら選択画面へ
          } else {
            this.editParticipant(res.result[0]);  // 該当が1件のみなら編集画面へ
          }
        }
      })
    });
  }

  /** selectParticipant: 複数検索結果からの選択
   * @param {object[]} arg - 候補者のオブジェクトの配列。[{項目名:値,..},{..},..]形式
   * @returns {void} なし
   */
  selectParticipant(arg){
    console.log('selectParticipant start. arg='+JSON.stringify(arg));
    this.dom.title.innerText = '対象者の選択';
    try {
      const editArea = this.dom.main;
      editArea.innerHTML = '<p>検索結果が複数あります。選択してください。</p>';
      for( let i=0 ; i<arg.length ; i++ ){
        const o = document.createElement('div');
        o.innerText = arg[i]['氏名'] + '(' + arg[i]['読み'] + ')';
        o.addEventListener('click',() => {
          editParticipant(arg[i]);  // 選択後編集画面へ
        });
        editArea.appendChild(o);
      }
      console.log('selectParticipant end.');
    } catch(e) {
      console.error('selectParticipant abnormal end.\n'+e.message);
      alert(e.message);
    }
  }

  /** editParticipant: 検索結果の内容編集
   * @param {object} - 編集対象のオブジェクト。{項目名:値,..}形式
   * @returns {void} なし
   */
  editParticipant(arg){
    console.log('editParticipant start. arg='+JSON.stringify(arg));
    this.dom.title.innerText = '参加者情報の編集';
    try {
      this.dom.main.innerHTML = '';
      this.entryNo = arg.entryNo;  // 更新時に利用

      // 01. 全体の枠組みを生成
      let o = genChild({class:'wrapper', children:[
        {class:'applicant'},          // 申込概要
        {class:'details none table'}, // 申込詳細
        {class:'members table'},      // 参加者リスト
        {class:'result none'}         // 更新結果表示
      ]});
      if( toString.call(o.result).match(/Error/) ){  // エラーObjが帰ったら
        throw o.result;
      } else if( o.append ){  // 追加フラグがtrueなら親要素に追加
        this.dom.main.appendChild(o.result);
      }

      // 02.申込概要
      // 02.1 空欄・読替処理
      arg.entryNo = ('000'+arg.entryNo).slice(-4);
      // 02.2 追加するテンプレートの作成
      const applicant = [
        {variable:'entryNo'},
        {tag:'ruby', children:[
          {tag:'rb', variable:'name00'},
          {tag:'rt', variable:'yomi00'}
        ]},
        {tag:'button', name:'details', text:'詳細'},
      ];
      // 02.3 追加処理
      for( let i=0 ; i<applicant.length ; i++ ){
        o = genChild(applicant[i],arg,'applicant'+i);
        if( toString.call(o.result).match(/Error/) ){  // エラーObjが帰ったら
          throw o.result;
        } else if( o.append ){  // 追加フラグがtrueなら親要素に追加
          this.dom.main.querySelector('.applicant').appendChild(o.result);
        }
      }
      // 02.4 イベントリスナの定義
      // 「詳細」ボタンクリック
      this.dom.main.querySelector('button[name="details"]').addEventListener('click',() => {
        const btn = this.dom.main.querySelector('button[name="details"]');
        if( btn.textContent === '詳細' ){
          toggleView(this.dom.main.querySelector('div.details'),true);
          btn.textContent = '閉じる';
        } else {
          toggleView(this.dom.main.querySelector('div.details'),false);
          btn.textContent = '詳細';
        }
      });

      // 03.申込詳細
      // 03.1 空欄・読替処理
      arg['タイムスタンプ'] = getJPDateTime(arg['タイムスタンプ']);
      arg.cancel = arg.cancel < 0 ? "取消済" : "( — )";
      // 03.2 追加するテンプレートの作成
      const details = [
        {class:'tr', children:[{class:'th', text:'受付日時'},{class:'td',variable:'タイムスタンプ'}]},
        {class:'tr', children:[{class:'th', text:'e-mail'},{class:'td',variable:'メールアドレス'}]},
        {class:'tr', children:[{class:'th', text:'緊急連絡先'},{class:'td',variable:'緊急連絡先'}]},
        {class:'tr', children:[{class:'th', text:'引取者'},{class:'td',variable:'引取者氏名'}]},
        {class:'tr', children:[{class:'th', text:'備考'},{class:'td',variable:'備考'}]},
        {class:'tr', children:[{class:'th', text:'キャンセル'},{class:'td',variable:'cancel'}]},
        {class:'tr', children:[{class:'th', text:'申込フォーム'},{class:'td qrcode'}]},
      ];
      // 03.3 追加処理
      for( let i=0 ; i<details.length ; i++ ){
        o = genChild(details[i],arg,'details'+i);
        if( toString.call(o.result).match(/Error/) ){  // エラーObjが帰ったら
          throw o.result;
        } else if( o.append ){  // 追加フラグがtrueなら親要素に追加
          this.dom.main.querySelector('.details').appendChild(o.result);
        }
      }
      // 申込フォームへの誘導用QRコード
      let qrcode = new QRCode(this.dom.main.querySelector('.qrcode'),{
        text: config.private.editURL,
        width: 200,
        height: 200,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      })
      // 03.4 イベントリスナの定義 ⇒ なし

      // 04.参加者リスト(状態・参加費)
      // 04.1 空欄・読替処理
      for( let i=0 ; i<4 ; i++ ){
        const num = ('0'+i).slice(-2);
        if( arg['status'+num].length === 0 ){
          arg['status'+num] = arg['name'+num].length === 0 ? '未登録' : '未入場';
        }
        if( arg['fee'+num].length === 0 ){
          arg['fee'+num] = arg['name'+num].length === 0 ? '無し' : '未収';
        }
      }
      // 04.2 追加するテンプレートの作成
      const maruNo = ['','①','②','③'];  // 丸数字
      const members = [{class:'tr', children:[ // 表のラベル行
        {class:'th no', text:'No'},
        {class:'th name', text:'氏名'},
        {class:'th status', text:'入退場'},
        {class:'th fee', text:'参加費'}
      ]}];
      for( let i=0 ; i<4 ; i++ ){   // 申込者、参加者行
        const num = ('0'+i).slice(-2);
        members.push({class:'tr',children:[
          {class:'td no', text:maruNo[i]},
          {class:'td name', text:arg['name'+num]},
          {class:'td status', children:[
            {tag:'select', name:'status'+num, variable:'status'+num, opt:['未入場','入場済','退場済','不参加','未登録']},
          ]},
          {class:'td fee', children:[
            {tag:'select', name:'fee'+num, variable:'fee'+num, opt:['未収','既収','免除','無し']},

          ]}
        ]});
      }
      members.push({class:'tr', children:[  // 更新・取消ボタン行
        {tag:'button', name:'cancel', text:'取消'},
        {tag:'button', name:'update', text:'更新'}
      ]});
      // 04.3 追加処理
      for( let i=0 ; i<members.length ; i++ ){
        o = genChild(members[i],arg,'members'+i);
        if( toString.call(o.result).match(/Error/) ){  // エラーObjが帰ったら
          throw o.result;
        } else if( o.append ){  // 追加フラグがtrueなら親要素に追加
          this.dom.main.querySelector('.members').appendChild(o.result);
        }
      }
      // 04.4 イベントリスナの定義
      // 「更新」ボタンクリック
      this.dom.main.querySelector('button[name="update"]').addEventListener('click',() => {
        this.updateParticipant();
      });
      // 「取消」ボタンクリック
      this.dom.main.querySelector('button[name="cancel"]').addEventListener('click',() => {
        this.display();
      });

      // 05.更新結果表示
      // 05.1 空欄・読替処理
      // 05.2 追加するテンプレートの作成
      const result = [
        {tag:'p', class:'message', text:''},
        {tag:'button', name:'result', text:'確認'}
      ];
      // 05.3 追加処理
      for( let i=0 ; i<result.length ; i++ ){
        o = genChild(result[i],arg,'result'+i);
        if( toString.call(o.result).match(/Error/) ){  // エラーObjが帰ったら
          throw o.result;
        } else if( o.append ){  // 追加フラグがtrueなら親要素に追加
          this.dom.main.querySelector('.result').appendChild(o.result);
        }
      }
      // 05.4 イベントリスナの定義
      this.dom.main.querySelector('button[name="result"]').addEventListener('click',() => {
        this.display();
      });

      console.log('editParticipant end.');

    } catch(e) {
      console.error('editParticipant abnormal end.\n'+e.message);
      alert(e.message);
    }  
  }

  /** updateParticipant: 参加者情報更新
   * @param {void} - なし
   * @returns {void} なし
   */
  updateParticipant(){
    console.log('updateParticipant start.');
    try {

      // 01.更新用のデータオブジェクトの作成
      const data = {};
      for( let i=0 ; i<4 ; i++ ){
        const num = ('0'+i).slice(-2);
        const s = this.dom.main.querySelector('select[name="status'+num+'"]');
        data['status'+num] = s.options[s.selectedIndex].value;
        const f = this.dom.main.querySelector('select[name="fee'+num+'"]');
        data['fee'+num] = f.options[f.selectedIndex].value;
      }
      console.log('l.395 data='+JSON.stringify(data));

      // 02.スプレッドシートの更新
      /* @param {string}   arg.to       - 受信側のコード名(平文)
      * @param {string}   arg.func     - GAS側で処理分岐の際のキー文字列
      * @param {any}      arg.data     - 処理対象データ
      * @param {function} arg.callback - GAS処理結果を受けた後続処理 */
      fetchGAS({
        to: 'Master',
        func: 'updateParticipant',
        data: {
          data: data,
          opt: {key:'entryNo',value:this.entryNo}
        },
        callback: (res) => {
          /* 03.更新結果の表示
            * <li>isErr {boolean} - エラーならtrue
            * <li>message {string} - エラーメッセージ
            * <li>result {object[]} - 更新結果。空なら変更なし
            * <ul>
            * <li>column {string} - 更新した項目名
            * <li>before {any} - 修正前の値
            * <li>after {any} - 修正後の値 */
          this.dom.main.querySelector('div.result').classList.replace('none','flex');
          const msg = this.dom.main.querySelector('.message');
          let message = '';
          if( res.isErr ){
            msg.classList.add('error');
            msg.innerText = res.message;
          } else if( res.result.length === 0 ){
            msg.innerText = '変更はありませんでした。';
          } else {
            msg.innerText = '更新が終了しました。';
          }
          console.log('updateParticipant end.\n'+JSON.stringify(res));
        }
      });
    
    } catch(e) {
      console.error(e.message);
      alert(e.message);
    }
  }
}
// :: page "reception" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "cornerOperation" Script section start. ::::::::::::::::::::::::::::::::::::::
// :: page "cornerOperation" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "entry" Script section start. ::::::::::::::::::::::::::::::::::::::
// :: page "entry" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "referState" Script section start. ::::::::::::::::::::::::::::::::::::::
// :: page "referState" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "information" Script section start. ::::::::::::::::::::::::::::::::::::::
// :: page "information" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "enquete" Script section start. ::::::::::::::::::::::::::::::::::::::
// :: page "enquete" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "system" Script section start. ::::::::::::::::::::::::::::::::::::::
  // 定期的処理の停止・再開
  // ボタンクリック時の動作を定義
  document.querySelector('.system input[name="start_stop"]').addEventListener('click',() => {
    if( !config.broadcast.intervalId || config.broadcast.intervalId === null ){
      // 停止中の場合
      config.broadcast.start();
      btn.value = '停止';
    } else {
      // 稼働中の場合
      config.broadcast.stop();
      btn.value = '再開';
    }
  });
// :: page "system" Script section end. ::::::::::::::::::::::::::::::::::::::::

window.addEventListener('DOMContentLoaded',() => {
  config.debugMode = 1; // 0:通常, 1:スタッフ, 2:参加者
  config.authorize = new Auth(()=>{ // menu/broadの初期化はconfig設定後
    // 以下、config設定が前提となる項目・画面を設定
    config.menu = new Menu();
    config.messageBoard = new messageBoard();
    config.reception = new Reception();

    // entry.html : 参加受付画面
    // 受付番号表示
    document.querySelector('.entry h1').innerText = '受付番号：' + config.entryStr;
    // 参加申込フォーム誘導用QRコードのセット
    let qrcode = new QRCode(document.querySelector('.entry div'),{
      text: config.entryStr,
      width: 300,
      height: 300,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    });
  });
});
</script>
</html>

