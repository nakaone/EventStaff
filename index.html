<!DOCTYPE html><html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>おまつり奉行</title>
<style type="text/css">
/* == ヘッダ ============================================= */
header {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 2rem;
  display: -webkit-flex;
  display: flex;
  -webkit-flex-direction: row;
  flex-direction: row;
  -webkit-justify-content: space-between;
  justify-content: space-between;
  margin-bottom: 1rem;
  background-color: #a0c238;
}
header .icon, .menuIcon {
  margin: 0.2rem;
  width: 1.6rem;
  height: 1.6rem;
}
header img {
  width: 100%;
  height: 100%;
}
header .title {
  margin: auto;
  width: calc(100% - 4rem);
  font-size: 1.2rem;
}

/* == メニュー =========================================== */
header .menu img {
  margin: 0.3rem;
  max-width: 1.4rem;
  max-height: 1.4rem;
}

nav {
  z-index: 10;
  background-color: rgba(0,0,0,.5);
  position: absolute;
  top: 2rem;
  right: 0;
  width: 15rem;
  height: calc(100% - 2rem);
}
nav ol {
  padding: 0;
  margin: 0;
}
nav li {
  list-style-type: none;
  margin: 0.75rem;
  padding-right: 0.8rem;
  border: solid 3px #888;
  width: calc(15rem - 2.5rem - 6px);
  color: white;
  text-align: right;
  transition: .5s;
}

/* == メイン ============================================= */
#main {
  position: absolute;
  margin: 0px;
  top: 2.5rem;
  left: 0px;
  width: 100%;
  height: calc(100% - 2.5rem);
  border: none;
}

div.screen {
  width: 100%;
  flex-direction: column;
}
div.area {
  width: 100%;
  flex-direction: column;
}

/* :: page "library" CSS section start. :::::::::::::::::::::::::::::::::::::: */
html {
  margin: 0;
  padding: 0;
  width: 100vw;
  height: 100vh;
  font-size: 4vw;
}

body {
  font-size: 1rem;
}

div {
  font-size: 1rem;
  margin: 0px;
  padding: 0px;
  box-sizing: border-box;
  display: flex;
  display: -webkit-flex;
}

div.table {
  width: 100%;
  flex-direction: column;
}
div.tr {
  width: 100%;
  padding: 0.25rem;
  flex-direction: row;
}

h1 {
  font-size: 1.6rem;
}

.error {
  color: red;
}
.flex {
  display: flex;
  display: -webkit-flex;
}
.hide {
  display: none;
}

button, input[type="button"] {
  font-size: 1rem;
}
/* :: page "library" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "menu" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "menu" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "authorize" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "authorize" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "messageBoard" CSS section start. :::::::::::::::::::::::::::::::::::::: */
.messageBoard div {
  flex-direction: column;
  width: 100%;
}

.messageBoard .postButton {
  margin: 0px 1rem;
  width: calc(100% - 2rem);
}

.messageBoard .postArea {
  margin: 1rem;
  padding: 0.5rem;
  width: calc(100% - 2rem);
  background-color: #deecc6;
}
.messageBoard .postArea div {
  margin-bottom: 0.5rem;
}
.messageBoard .postArea .fromto {
  flex-direction: row;
  padding-right: 1rem;
}
.messageBoard .postArea .fromto label {
  display: block;
  float: left;
  width: 4rem;
}
.messageBoard .postArea .fromto input, select {
  width: 8rem;
}
.messageBoard .postArea textarea {
  width: auto;
  height: 4rem;
}

.messageBoard .broadArea {
  padding: 0 1rem;
  margin-top: 1rem;
  height: 100%;
  overflow: auto;
}
.messageBoard .broadArea p {
  width: 100%;
  margin-top: 0;
  margin-bottom: 0.5rem;
}
.messageBoard .broadArea p.date {
  width: calc(100% - 1rem);
  padding-left: 1rem;
  background-color: forestgreen;
  color: white;
}
.messageBoard .broadArea p.title {
  margin-bottom: 0.2rem;
  background-color: #a0c238;
  font-size: 0.8rem;
}
/* :: page "messageBoard" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "reception" CSS section start. :::::::::::::::::::::::::::::::::::::: */
.reception .entryNo {
  flex-direction: column;
  flex-wrap: nowrap;
}
.reception .entryNo input {
  font-size: 1rem;
  width: 4rem;
  margin-left: 2rem;
}

.reception .paperForm {
  flex-direction: column;
}

/* 登録フォーム誘導・紙申請処理ボタン */
.reception > div {
  margin: 1rem 0;
  -webkit-justify-content: space-around;
  justify-content: space-around;
}
.reception > div:first-child > button {
  width: 40%;
}

/* 受付番号または氏名での検索窓 */
.reception input {
  width: 15rem;
}

/* 該当者検索後の編集画面 */
.reception .wrapper {
  flex-direction: column;
}
.reception .applicant {
  font-size: 1.5rem;
}
.reception .applicant button {
  height: 1.8rem;
  margin-left: auto;
}
.reception .details {
  margin: 1rem 0;
}
.reception .details .th {
  width: 8rem;
}
.reception .details div.tr:nth-child(odd) {
  background-color: #aff;
}
.reception .members .no {
  width: 10%;
}
.reception .members .name {
  width: 40%;
}
.reception .members .status,.fee {
  width: 25%;
}
.reception .members div.tr:nth-child(odd) {
  background-color: #bfb;
}
.reception .members div.tr:last-child {
  -webkit-justify-content: space-between;
  justify-content: space-between;
  margin-top: 1rem;
}
.reception .result {
  flex-direction: column;
}

/* :: page "reception" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "paperForm" CSS section start. :::::::::::::::::::::::::::::::::::::: */
.paperForm .step1 {
  flex-direction: column;
}
/* :: page "paperForm" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "applicationQR" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "applicationQR" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "cornerOperation" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "cornerOperation" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "entry" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "entry" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "referState" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "referState" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "information" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* https://pulpxstyle.com/css-button/ */
div.button a {
  text-decoration: none;

  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  /*margin: 0 auto;*/
  margin: 1rem;
  padding: 1em 2em;
  /*width: 300px;*/
  width: calc(100% - 6rem);
  color: #333;
  font-size: 18px;
  font-weight: 700;
  background-color: #ccc;
  transition: 0.3s;
}

div.button a::before {
  content: '';
  position: absolute;
  top: -5px;
  left: -5px;
  width: calc(100% - 4px);
  height: calc(100% - 4px);
  border: 2px solid #3d9ec8;
  transition: 0.2s;
}

div.button a::after {
  content: '';
  width: 5px;
  height: 5px;
  border-top: 3px solid #333333;
  border-right: 3px solid #333333;
  transform: rotate(45deg);
}

div.button a:hover::before {
  top: 0;
  left: 0;
}

div.button a:hover {
  text-decoration: none;
  background-color: #a0c4d3;
}
/* :: page "information" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "enquete" CSS section start. :::::::::::::::::::::::::::::::::::::: */
/* :: page "enquete" CSS section end. :::::::::::::::::::::::::::::::::::::::: */


/* :: page "system" CSS section start. :::::::::::::::::::::::::::::::::::::: */
div.system div {
  flex-direction: column;
}
/* :: page "system" CSS section end. :::::::::::::::::::::::::::::::::::::::: */

</style>
</head>
<body>
  <header>
    <div class="icon"><img src="img/stamp.png" /></div>
    <div class="title"></div>
    <div class="menuIcon"></div>
  </header>
  <nav>
    <ol>
      <li name="messageBoard">お知らせ</li>
      <li name="reception">受付業務</li>
      <li name="cornerOperation">コーナー運営</li>
      <li name="entry">参加受付</li>
      <li name="referState">予約状況参照</li>
      <li name="information">お役立ち情報</li>
      <li name="enquete">参加者アンケート</li>
      <li name="system">システム設定</li>
    </ol>
  </nav>
  <div id="main">

<div class="screen library"><!-- :: page "library" HTML section start. ::::::::::: -->
</div><!-- page "library" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen menu"><!-- :: page "menu" HTML section start. ::::::::::: -->
</div><!-- page "menu" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen authorize"><!-- :: page "authorize" HTML section start. ::::::::::: -->
  <div class="entryNo">
    <p>受付番号を入力してください</p>
    <div>
      <input type="text" />
      <input type="button" value="送信" />,\n
    </div>
    <div class="message"></div>
  </div>

  <div class="passCode hide">
    <p>確認のメールを送信しました。記載されているパスコード(数字6桁)を入力してください。<br>
    ※まれに迷惑メールと判定される場合があります。メールが来ない場合、そちらもご確認ください。</p>
    <input type="text" />
    <input type="button" value="送信" />
    <div class="message">※パスコードの有効期限は1時間です</div>
  </div>
</div><!-- page "authorize" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen messageBoard"><!-- :: page "messageBoard" HTML section start. ::::::::::: -->
  <div class="postButton">
    <input type="button" value="投稿する" />
  </div>
  <div class="postArea hide">
    <div class="fromto">
      <div>
        <label>From</label>
        <input type="text" name="from" width="100%"
          placeholder="ハンドルネームを入力"
          onchange="config.handleName=this.value"
        />
      </div>
      <div>
        <label>To</label>
        <select name="to">
          <option value="スタッフ全員">スタッフ全員</option>
          <option value="本部">本部</option>
          <option value="カレー担当">カレー担当</option>
          <option value="校内探検担当">校内探検担当</option>
          <option value="受付担当">受付担当</option>
          <option value="金魚すくい担当">金魚すくい担当</option>
          <option value="射的担当">射的担当</option>
        </select>
      </div>
    </div>
    <div class="message">
      <textarea></textarea>
    </div>
    <div class="submit">
      <input type="button" name="sendMessage" value="送信" />
    </div>
  </div>

  <div class="broadArea"></div>
</div><!-- page "messageBoard" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen reception"><!-- :: page "reception" HTML section start. ::::::::::: -->
  <div class="area receptionMain">
    <!-- サブメニュー -->
    <div>
      <button onclick="config.menu.changeScreen('applicationQR')">登録フォーム誘導</button>
      <button onclick="config.menu.changeScreen('paperForm')">紙申請処理</button>
    </div>

    <!-- 該当者検索 -->
    <div class="inputKey">
      <input type="text" placeholder="&#x1F50D受付番号または氏名読み(最初の数文字)" />
      <button onclick="config.reception.search()">検索</button>
    </div>
    <div class="scanner"></div><!-- QRコードスキャナ -->
  </div>

  <!-- 返信待ち -->
  <div class="area searching">
    <img src="img/loading.gif" />
  </div>

  <!-- エラーメッセージ表示領域 -->
  <div class="area error">
    <h1 class="error">Error</h1>
    <p></p>
  </div>

  <!-- 複数検索結果からの選択 -->
  <div class="area select"></div>

  <!-- 検索結果の内容編集 -->
  <div class="area edit">
    <div class="applicant"><!-- 申込概要 -->
      <div class="entryNo"></div>
      <ruby><rb></rb><rt></rt></ruby>
      <button name="details">詳細</button>
    </div>
    <div class="details hide table"><!-- 申込詳細 -->
      <div class="tr">
        <div class="th">受付日時</div><div class="td timestamp"></div>
      </div>
      <div class="tr">
        <div class="th">e-mail</div><div class="td email"></div>
      </div>
      <div class="tr">
        <div class="th">緊急連絡先</div><div class="td tel"></div>
      </div>
      <div class="tr">
        <div class="th">引取者</div><div class="td pickup"></div>
      </div>
      <div class="tr">
        <div class="th">備考</div><div class="td note"></div>
      </div>
      <div class="tr">
        <div class="th">キャンセル</div><div class="td cancel"></div>
      </div>
      <div class="tr">
        <div class="th">申込フォーム</div><div class="td qrcode"></div>
      </div>
    </div>
    <div class="members table"><!-- 参加者リスト -->
      <div class="tr">
        <div class="th">No</div>
        <div class="th">氏名</div>
        <div class="th">入退場</div>
        <div class="th">参加費</div>
      </div>
      <div class="tr n00">
        <div class="td no"></div>
        <div class="td name"></div>
        <div class="td status"><select name="status00">
          <option value="未入場">未入場</option>
          <option value="入場済">入場済</option>
          <option value="退場済">退場済</option>
          <option value="不参加">不参加</option>
          <option value="未登録">未登録</option>
        </select></div>
        <div class="td fee"><select name="fee00">
          <option value="未収">未収</option>
          <option value="既収">既収</option>
          <option value="免除">免除</option>
          <option value="無し">無し</option>
        </select></div>
      </div>
      <div class="tr n01">
        <div class="td no">①</div>
        <div class="td name"></div>
        <div class="td status"><select name="status01">
          <option value="未入場">未入場</option>
          <option value="入場済">入場済</option>
          <option value="退場済">退場済</option>
          <option value="不参加">不参加</option>
          <option value="未登録">未登録</option>
        </select></div>
        <div class="td fee"><select name="fee01">
          <option value="未収">未収</option>
          <option value="既収">既収</option>
          <option value="免除">免除</option>
          <option value="無し">無し</option>
        </select></div>
      </div>
      <div class="tr n02">
        <div class="td no">②</div>
        <div class="td name"></div>
        <div class="td status"><select name="status02">
          <option value="未入場">未入場</option>
          <option value="入場済">入場済</option>
          <option value="退場済">退場済</option>
          <option value="不参加">不参加</option>
          <option value="未登録">未登録</option>
        </select></div>
        <div class="td fee"><select name="fee02">
          <option value="未収">未収</option>
          <option value="既収">既収</option>
          <option value="免除">免除</option>
          <option value="無し">無し</option>
        </select></div>
      </div>
      <div class="tr n03">
        <div class="td no">③</div>
        <div class="td name"></div>
        <div class="td status"><select name="status03">
          <option value="未入場">未入場</option>
          <option value="入場済">入場済</option>
          <option value="退場済">退場済</option>
          <option value="不参加">不参加</option>
          <option value="未登録">未登録</option>
        </select></div>
        <div class="td fee"><select name="fee03">
          <option value="未収">未収</option>
          <option value="既収">既収</option>
          <option value="免除">免除</option>
          <option value="無し">無し</option>
        </select></div>
      </div>
      <div class="tr">
        <button name="cancel">取消</button>
        <button name="update">更新</button>
      </div>
    </div>
    <div class="result hide"><!-- 更新結果表示 -->
      <p></p>
      <button>確認</button>
    </div>
  </div>
</div><!-- page "reception" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen paperForm"><!-- :: page "paperForm" HTML section start. ::::::::::: -->
  <div class="area step1">
    <div><p>申込者の属性を入力してください</p></div>
    <div><table>
      <tr><th>No</th><th>属性</th></tr>
      <tr><td>①</td><td><select>
        <option value="未就学児">未就学児</option>
        <option value="小1">小1</option>
        <option value="小2">小2</option>
        <option value="小3">小3</option>
        <option value="小4">小4</option>
        <option value="小5">小5</option>
        <option value="小6">小6</option>
        <option value="卒業生">卒業生</option>
        <option value="保護者">保護者</option>
      </select></td></tr>
      <tr><td>②</td><td><select>
        <option value="未就学児">未就学児</option>
        <option value="小1">小1</option>
        <option value="小2">小2</option>
        <option value="小3">小3</option>
        <option value="小4">小4</option>
        <option value="小5">小5</option>
        <option value="小6">小6</option>
        <option value="卒業生">卒業生</option>
        <option value="保護者">保護者</option>
      </select></td></tr>
      <tr><td>③</td><td><select>
        <option value="未就学児">未就学児</option>
        <option value="小1">小1</option>
        <option value="小2">小2</option>
        <option value="小3">小3</option>
        <option value="小4">小4</option>
        <option value="小5">小5</option>
        <option value="小6">小6</option>
        <option value="卒業生">卒業生</option>
        <option value="保護者">保護者</option>
      </select></td></tr>
      <tr><td>④</td><td><select>
        <option value="未就学児">未就学児</option>
        <option value="小1">小1</option>
        <option value="小2">小2</option>
        <option value="小3">小3</option>
        <option value="小4">小4</option>
        <option value="小5">小5</option>
        <option value="小6">小6</option>
        <option value="卒業生">卒業生</option>
        <option value="保護者">保護者</option>
      </select></td></tr>
      <tr><td>⑤</td><td><select>
        <option value="未就学児">未就学児</option>
        <option value="小1">小1</option>
        <option value="小2">小2</option>
        <option value="小3">小3</option>
        <option value="小4">小4</option>
        <option value="小5">小5</option>
        <option value="小6">小6</option>
        <option value="卒業生">卒業生</option>
        <option value="保護者">保護者</option>
      </select></td></tr>
    </table></div>
    <div><button>次へ</button></div>
  </div>

  <div class="area step2 hide">
    <h1>受付番号：</h1>
    <p>申込用紙に上の受付番号を記入の上、用紙を撮影してください</p>
  </div>
</div><!-- page "paperForm" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen applicationQR"><!-- :: page "applicationQR" HTML section start. ::::::::::: -->
  <p>スマホをお持ちの場合、以下のフォームから申請をお願いします。</p>
  <div class="qrcode"></div>
  <button onclick="config.menu.changeScreen('reception')">受付業務に戻る</button>
</div><!-- page "applicationQR" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen cornerOperation"><!-- :: page "cornerOperation" HTML section start. ::::::::::: -->
</div><!-- page "cornerOperation" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen entry"><!-- :: page "entry" HTML section start. ::::::::::: -->
  <button>参加者の追加・変更・取消</button>
  <h1></h1>
  <div></div>
</div><!-- page "entry" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen referState"><!-- :: page "referState" HTML section start. ::::::::::: -->
  <h1 style="text-align:center">(未実装)</h1>
</div><!-- page "referState" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen information"><!-- :: page "information" HTML section start. ::::::::::: -->
  <div class="button"><a href="../materials/timetable/WBS.html" target="_blank">進行予定</a></div>
  <div class="button"><a href="../materials/map.html" target="_blank">校内案内図</a></div>
  <div class="button"><a href="https://sites.google.com/view/shimokita-oyaji/home/archives/20221001-%E6%A0%A1%E5%BA%AD%E3%83%87%E3%82%A4%E3%82%AD%E3%83%A3%E3%83%B3%E3%83%97" target="_blank">募集要項</a></div>
</div><!-- page "information" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen enquete"><!-- :: page "enquete" HTML section start. ::::::::::: -->
</div><!-- page "enquete" HTML section end. ::::::::::::::::::::::::::::::::: -->


<div class="screen system"><!-- :: page "system" HTML section start. ::::::::::: -->
  <div>
    <h1>定期的処理の停止・再開</h1>
    <input type="button" name="start_stop" value="停止" />
  </div>

  <div>
    <h1>ヘルプ</h1>
    <details><summary>[Android]カメラを使おうとすると「使用できません」と表示される</summary>
      <p>ブラウザにカメラを使用する権限が付与されていない場合に表示されます。対応は以下の通りです(<a href="https://support.google.com/android/answer/9431959?hl=ja" target="_blank">出典</a>)。</p>
      <ol>
        <li>設定 > アプリ > 変更するアプリ(ブラウザ)を選択 > 権限 > カメラ</li>
        <li>「許可しない」から「アプリの使用中のみ許可」または「毎回確認する」に変更</li>
      </ol>
    </details>
  </div>

  <div>
    <h1>おまつり奉行について</h1>
    <p>about OMATSURI-Bugyo</p>
    <p>version: 1.1.0 (Dec.13,2022 released)</p>
    <p>
      author :
      <a mailto="nakaone.kunihiro@gmail.com">
        <ruby>
          <rb>嶋津　邦浩</rb>
          <rt>2-2ゆうなパパ</rt>
        </ruby>
      </a>
      (Shimazu Kunihiro)
    </p>
    <p>
      License:
      <a href="https://opensource.org/licenses/mit-license.php" target="_blank">MIT</a>
    </p>
  </div>
</div><!-- page "system" HTML section end. ::::::::::::::::::::::::::::::::: -->

  </div>
</body>
<script src="js/jsQR.js" defer></script><!-- QRコード検出 -->
<script src="js/qrcode.min.js" defer></script><!-- QRコード生成 -->
<script type="text/javascript">
const config = {};

// :: page "library" Script section start. ::::::::::::::::::::::::::::::::::::::
/** webScanner: QRコードや文書をスキャン
 * <br>
 * 指定セレクタ以下にcanvas他の必要な要素を作成してスキャン実行、指定の後続処理を呼び出す。<br>
 * 呼び出す前に`config.scanCode = true`を実行しておくこと。<br>
 * 参考：[jsQRであっさりQRコードリーダ/メーカ](@link https://zenn.dev/sdkfz181tiger/articles/096dfb74d485db)
 */
 class webScanner {
  /** constructor
   * @param {object} arg
   * @param {object} arg.parent - 親要素(DOM object)
   * @param {number} arg.interval - 動画状態で撮像、読み込めなかった場合の時間間隔
   * @param {object} arg.RegExp - QRコードスキャン時、内容が適切か判断
   * @param {boolean} arg.alert - 読み込み完了時に内容をalert表示するか
   * @returns {void} なし
   */
  constructor(arg={}){
    console.log('webScanner.constructor start. opt='+JSON.stringify(arg));

    // デバイスがサポートされているか確認
    if (!('mediaDevices' in navigator) || !('getUserMedia' in navigator.mediaDevices)) {
      const msg = 'デバイス(カメラ)がサポートされていません';
      console.error('webScanner.constructor: '+msg);
      alert(msg);
      return;
    }

    this.parent = arg.parent;
    this.interval = arg.interval || 0.25;
    this.RegExp = arg.RegExp || /.+/;
    this.alert = arg.alert || false;
    this.onGoing = false; // カメラ動作中はtrue
    console.log('webScanner.constructor end.');
  }

  /** start: カメラを起動する(private関数)
   * @param {void} - なし
   * @returns {void} なし
   */
  start(){
    console.log('webScanner start start.');

    // カメラやファインダ等の作業用DIVを追加
    this.parent.innerHTML = '<canvas></canvas>';
    this.video = document.createElement('video');
    this.canvas = this.parent.querySelector('canvas');
    this.ctx = this.canvas.getContext('2d');

    // 動画撮影用Webカメラを起動
    navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: "environment",
      },
      audio: false
    }).then((stream) => {
      this.video.srcObject = stream;
      this.video.setAttribute("playsinline", true);
      this.video.play();
      this.onGoing = true;  // カメラ動作中フラグを立てる
      this.drawFinder();  // キャンパスへの描画をスタート
    }).catch(e => {
      alert('カメラを使用できません\n'+e.message);
    });
  }

  /** stop: カメラを停止する(private関数)
   * @param {void} - なし
   * @returns {void} なし
   */
  stop(){
    console.log('webScanner.stop',this.video);
    this.video.srcObject.getVideoTracks().forEach((track) => {
      track.stop();
    });
    this.parent.innerHTML = ''; // 作業用DIVを除去
    this.onGoing = false;
  }

  /** scanDoc: 文書のスキャン */
  scanDoc(callback){

    // 親要素にカメラやファインダ等の作業用DIVを追加
    this.parent.innerHTML
    = '<video autoplay></video>'
    + '<canvas></canvas>'  // 撮影結果
    + '<div>'  // カメラ操作ボタン
    + '<input type="button" name="undo" value="◀" />'
    + '<input type="button" name="shutter" value="[ ● ]" />'
    + '<input type="button" name="adopt" value="▶" />'
    + '</div>';
    this.video = this.parent.querySelector('video');
    this.video.style.display = 'block';
    this.canvas = this.parent.querySelector('canvas');
    this.canvas.style.display = 'none';
    this.ctx = this.canvas.getContext('2d');

    // カメラ操作ボタン関係の定義
    this.buttons = this.parent.querySelector('div');
    this.buttons.style.display = 'none'; //最初は全部隠蔽
    this.undo = this.buttons.querySelector('input[name="undo"]');
    this.undo.disabled = true;  // 再撮影
    this.shutter = this.buttons.querySelector('input[name="shutter"]');
    this.shutter.disabled = false;  // シャッター
    this.adopt = this.buttons.querySelector('input[name="adopt"]');
    this.adopt.disabled = true;  // 採用

    // 1. スキャナのボタン操作時の定義
    // (1) 再撮影ボタンクリック時
    this.undo.addEventListener('click',() => {
      this.video.style.display = 'block';
      this.canvas.style.display = 'none';
      this.undo.disabled = true;
      this.shutter.disabled = false;
      this.adopt.disabled = true;
    });
    // (2) シャッタークリック時
    this.shutter.addEventListener('click',() => {
      this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
      this.video.style.display = 'none';
      this.canvas.style.display = 'block';
      this.undo.disabled = false;
      this.shutter.disabled = true;
      this.adopt.disabled = false;
    });
    // (3) 採用ボタンクリック時
    this.adopt.addEventListener('click',() => {
      // 正常終了時はスキャナを停止
      this.parent.innerHTML = '';
      this.stop();
      // canvasからイメージをBASE64で取得
      const imageData = this.canvas.toDataURL('image/png',0.7);
      const postData = {
        timestamp: getJPDateTime(),
        image: imageData,
      }
      fetchGAS({
        from: 'scanDocHtml',
        to:   'scanDoc',
        func: 'scanDoc',
        data: postData,
        callback: res => {
          if( res.isErr ){
            alert(res.message);
          } else {
            console.log('scanDoc normal end.',res);
          }
        }
      });
      // 以下は圧縮検討時のメモ。削除可
      //const imageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
      //imageCompression(imageData,{maxSizeMB:1,maxWidthOrHeight:1280}).then(data => {
      //  this.ctx.putImageData(data,0,0,this.canvas.width,this.canvas.height);

    })

    // 2. カメラ操作ボタンを表示してカメラを起動
    this.buttons.style.display = 'flex';
    this.start(()=>{console.log('Camera getting started!')});
  }

  /** scanQR: QRコードスキャン
   * @param {function} callback - 後続処理
   * @param {object} opt - オプション
   * @param {object} opt.RegExp - スキャン結果が適切か判断。RegExpオブジェクト
   * @param {boolean} opt.alert - true:読み込み完了時に内容をalert表示
   * @returns {void} なし
   */
  scanQR(callback,opt={}){
    console.log('webScanner.scanQR start. opt='+JSON.stringify(opt)+'\n',callback);

    // 既定値の設定
    this.RegExp = opt.RegExp || this.RegExp;
    this.alert = opt.alert || this.alert;
    this.callback = callback; // 後続処理をメンバとして保存

    // 動画撮影用Webカメラを起動
    this.start();
  }

  drawFinder(){  // キャンバスに描画する
    //console.log('webScanner.drawFinder start.',this.video);

    // スキャン実行フラグが立っていなかったら終了
    if( !this.onGoing )  return;

    if(this.video.readyState === this.video.HAVE_ENOUGH_DATA){

      // 親要素の横幅に合わせて表示する
      const ratio = this.parent.clientWidth / this.video.videoWidth;
      //console.log('l.196 this.parent.clientWidth='+this.parent.clientWidth+', this.video.videoWidth='+this.video.videoWidth+' -> ratio='+ratio);
      const w = this.video.videoWidth * ratio;
      const h = this.video.videoHeight * ratio;
      //console.log('l.199 w ='+w+', h='+h);
      this.video.width = this.canvas.width = w;
      this.video.height = this.canvas.height = h;

      this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
      let img;
      try { // canvasを含む要素が削除済の場合にエラーとなるので回避
        img = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
      } catch(e) {
        console.log(e.message);
        this.stop();
        return;
      }
      // このタイミングでQRコードを判定
      let code = jsQR(img.data, img.width, img.height, {inversionAttempts: "dontInvert"});
			if(code){
        console.log('drawFinder: code='+JSON.stringify(code));
        // QRコード読み取り成功
				this.drawRect(code.location);// ファインダ上のQRコードに枠を表示
        if( this.alert ) alert(code.data);  // alert出力指定があれば出力
        if( code.data.match(this.RegExp) ){  // 正しい内容が読み込まれた場合
          this.drawRect(code.location);
          this.stop();
          this.callback(code.data); // 読み込んだQRコードを引数にコールバック
        } else {
          // 不適切な、別のQRコードが読み込まれた場合
          alert('不適切なQRコードです。再読込してください。');
          console.log('[scanCode.drawFinder] Error: not match pattern. code='+code.data);
          // 再読込。drawFinderはクラス内のメソッドなのでアロー関数で呼び出す
          // MDN setTimeout() thisの問題
          // https://developer.mozilla.org/ja/docs/Web/API/setTimeout#this_%E3%81%AE%E5%95%8F%E9%A1%8C
          setTimeout(()=>this.drawFinder(), this.interval);
        }
			}
    }
    setTimeout(()=>this.drawFinder(), this.interval);
  }

  drawRect(location){  // ファインダ上のQRコードに枠を表示
    console.log('webScanner.drawRect location='+JSON.stringifylocation);
    this.drawLine(location.topLeftCorner,     location.topRightCorner);
		this.drawLine(location.topRightCorner,    location.bottomRightCorner);
		this.drawLine(location.bottomRightCorner, location.bottomLeftCorner);
		this.drawLine(location.bottomLeftCorner,  location.topLeftCorner);
  }

  drawLine(begin, end){  // ファインダ上に線を描画
    console.log('webScanner.drawLine begin='+begin+', end='+end);
		this.ctx.lineWidth = 4;
		this.ctx.strokeStyle = "#FF3B58";
		this.ctx.beginPath();
		this.ctx.moveTo(begin.x, begin.y);
		this.ctx.lineTo(end.x, end.y);
		this.ctx.stroke();
	}
}

/* ===================================================
  汎用ライブラリ(GAS,JavaScript共通)
=================================================== */

/** analyzePath: パス名文字列から構成要素を抽出
 * @param {string} arg - パス文字列
 * @returns {object} 以下のメンバを持つオブジェクト
 * <ul>
 * <li> full {string} - 引数の文字列(フルパス)
 * <li> path {string} - ファイル名を除いたパス文字列
 * <li> file {string} - ファイル名
 * <li> base {string} - 拡張子を除いたベースファイル名
 * <li> suffix {string} - 拡張子
 * </ul>
 */
const analyzePath = (arg) => {
  const rv = {full:arg};
  const m1 = arg.match(/^(.*)\/([^\/]+)$/);
  if( m1 ){
    rv.path = m1[1] + '/';
    rv.file = m1[2];
  } else {
    rv.path = '';
    rv.file = arg;
  }
  const m2 = rv.file.match(/^(.+)\.([^\.]+?)$/);
  if( m2 ){
    rv.base = m2[1];
    rv.suffix = m2[2];
  } else {
    rv.base = rv.file;
    rv.suffix = '';
  }
  return rv;
}

/** convertCharacters: 文字種を変換
 * <br><br>
 * 全角英数字は半角に、半角片仮名は全角に強制的に変換。<br>
 * 全角ひらがな<->全角カタカナは引数(kana)で指定。既定値はひらがなに変換。<br>
 * <br>参考：
 * <ul>
 * <li>[全角ひらがな⇔全角カタカナの文字列変換]{@link https://neko-note.org/javascript-hiragana-katakana/1024}
 * <li>[全角⇔半角の変換を行う(英数字、カタカナ)]{@link https://www.yoheim.net/blog.php?q=20191101}
 * </ul>
 * @param {string} str - 変換対象文字列
 * @param {boolean} kana - true:ひらがな、false:カタカナ
 * @returns {string} 変換結果
 */
function convertCharacters(str,kana=true){
  let rv = str;
  // 全角英数字 -> 半角英数字
  rv = rv.replace(/[Ａ-Ｚａ-ｚ０-９]/g, (s) => {
    return String.fromCharCode(s.charCodeAt(0) - 65248);
  });

  // 半角カタカナ -> 全角カタカナ
  const hankaku = (arg) => {
    const kanaMap = {
      'ｶﾞ': 'ガ', 'ｷﾞ': 'ギ', 'ｸﾞ': 'グ', 'ｹﾞ': 'ゲ', 'ｺﾞ': 'ゴ',
      'ｻﾞ': 'ザ', 'ｼﾞ': 'ジ', 'ｽﾞ': 'ズ', 'ｾﾞ': 'ゼ', 'ｿﾞ': 'ゾ',
      'ﾀﾞ': 'ダ', 'ﾁﾞ': 'ヂ', 'ﾂﾞ': 'ヅ', 'ﾃﾞ': 'デ', 'ﾄﾞ': 'ド',
      'ﾊﾞ': 'バ', 'ﾋﾞ': 'ビ', 'ﾌﾞ': 'ブ', 'ﾍﾞ': 'ベ', 'ﾎﾞ': 'ボ',
      'ﾊﾟ': 'パ', 'ﾋﾟ': 'ピ', 'ﾌﾟ': 'プ', 'ﾍﾟ': 'ペ', 'ﾎﾟ': 'ポ',
      'ｳﾞ': 'ヴ', 'ﾜﾞ': 'ヷ', 'ｦﾞ': 'ヺ',
      'ｱ': 'ア', 'ｲ': 'イ', 'ｳ': 'ウ', 'ｴ': 'エ', 'ｵ': 'オ',
      'ｶ': 'カ', 'ｷ': 'キ', 'ｸ': 'ク', 'ｹ': 'ケ', 'ｺ': 'コ',
      'ｻ': 'サ', 'ｼ': 'シ', 'ｽ': 'ス', 'ｾ': 'セ', 'ｿ': 'ソ',
      'ﾀ': 'タ', 'ﾁ': 'チ', 'ﾂ': 'ツ', 'ﾃ': 'テ', 'ﾄ': 'ト',
      'ﾅ': 'ナ', 'ﾆ': 'ニ', 'ﾇ': 'ヌ', 'ﾈ': 'ネ', 'ﾉ': 'ノ',
      'ﾊ': 'ハ', 'ﾋ': 'ヒ', 'ﾌ': 'フ', 'ﾍ': 'ヘ', 'ﾎ': 'ホ',
      'ﾏ': 'マ', 'ﾐ': 'ミ', 'ﾑ': 'ム', 'ﾒ': 'メ', 'ﾓ': 'モ',
      'ﾔ': 'ヤ', 'ﾕ': 'ユ', 'ﾖ': 'ヨ',
      'ﾗ': 'ラ', 'ﾘ': 'リ', 'ﾙ': 'ル', 'ﾚ': 'レ', 'ﾛ': 'ロ',
      'ﾜ': 'ワ', 'ｦ': 'ヲ', 'ﾝ': 'ン',
      'ｧ': 'ァ', 'ｨ': 'ィ', 'ｩ': 'ゥ', 'ｪ': 'ェ', 'ｫ': 'ォ',
      'ｯ': 'ッ', 'ｬ': 'ャ', 'ｭ': 'ュ', 'ｮ': 'ョ',
      '｡': '。', '､': '、', 'ｰ': 'ー', '｢': '「', '｣': '」', '･': '・'
    };

    const reg = new RegExp('(' + Object.keys(kanaMap).join('|') + ')', 'g');
    return arg
      .replace(reg, function (match) {
          return kanaMap[match];
      })
      .replace(/ﾞ/g, '゛')
      .replace(/ﾟ/g, '゜');
  };
  rv = hankaku(rv);

  // 全角カタカナ <-> 全角ひらがな
  const hRep = (x,offset,string) => { // offset:マッチした位置 string:文字列全部
    //console.log('hRep start.',x,offset,string);
    let rv = String.fromCharCode(x.charCodeAt(0) - 0x60);
    //console.log('hRep end.',rv);
    return rv;
  }
  const toHiragana = (t) => {
    //console.log('toHiragana start.',typeof t, t);
    let rv = t.replace(/[\u30A1-\u30FA]/g,hRep);
    //console.log('toHiragana end.',typeof(rv),rv);
    return rv;
  };

  const kRep = (x,offset,string) => {
    //console.log('kRep start.',x,offset,string);
    let rv = String.fromCharCode(x.charCodeAt(0) + 0x60);
    //console.log('kRep end.',rv);
    return rv;
  }
  const toKatakana = (t) => {
    //console.log('toKatakana start.',typeof t, t);
    let rv = t.replace(/[\u3041-\u3096]/g,kRep);
    //console.log('toKatakana end.',typeof(rv),rv);
    return rv;
  };

  rv = kana ? toHiragana(rv) : toKatakana(rv);
  //console.log('convertCharacters end. rv=',rv);
  return rv;
}

/** getJPDateTime: 指定日時文字列を作成
 * @param {any} dt - 作成する日時の指定。省略時は現在時刻
 * @param {string} locale - 作成する形式
 * @returns {string} 指定形式＋ミリ秒の日時文字列
 * なおゼロパディングして2桁に整形するためには、replace【×2】が必要。<br>
 * ∵隣接する箇所と重複があると置換対象から外れる(下例の2日の部分)<br>
 * ex. '2022/1/2 3:04:5.678'.replace(/(\D)(\d)(\D)/g,'$10$2$3')<br>
 *     ⇒ '2022/01/2 03:04:05.678'
 */
function getJPDateTime(dt=null,locale='ja-JP'){
  const tObj = dt === null ? new Date() : new Date(dt);
  return (tObj.toLocaleString(locale) + '.' + tObj.getMilliseconds())
  .replace(/(\D)(\d)(\D)/g,'$10$2$3').replace(/(\D)(\d)(\D)/g,'$10$2$3');
}

/** initClass: 要素に定義されたクラスを全削除して新たなクラスを定義
 * @param {object} element - 対象となる要素
 * @param {string} iClass  - 新たに設定するクラス
 * @returns {void} なし
 */
const initClass = (element,iClass) => {
  element.classList.remove(...element.classList);
  element.classList.add(iClass);
}

/** toggleView: ブロック要素の表示(flex)/非表示(none)を切り替え
 * @param {object} element - 切換対象要素(ex.DIV)
 * @param {boolean} force - true:強制的に表示, false:強制的に非表示
 * @returns {void} なし
 */
const toggleView = (element,force) => {
  console.log('toggleView classList="'+element.classList.value+'", force='+force);
  if( force || element.classList.contains('none') ){
    element.classList.remove('none');
    element.classList.add('flex');
  } else {
    element.classList.remove('flex');
    element.classList.add('none');
  }
}

/** whichType: 変数の型を判定
 * @param {any} arg - 判定対象の変数
 * @returns {string} - 型の名前
 */
const whichType = (arg = undefined) => {
  return arg === undefined ? 'undefined'
   : Object.prototype.toString.call(arg).match(/^\[object\s(.*)\]$/)[1];
}

/* ===================================================
  汎用ライブラリ(JavaScript専用,非GAS)
=================================================== */

/** fetchGAS: GASのdoPostを呼び出し、後続処理を行う
 * <br>
 * 処理内部で使用する公開鍵・秘密鍵はszLib.getUrlKey()で取得。
 *
 * @param {object}   arg          - 引数
 * @param {string}   arg.to       - 受信側のコード名(平文)
 * @param {string}   arg.func     - GAS側で処理分岐の際のキー文字列
 * @param {any}      arg.data     - 処理対象データ
 * @param {function} arg.callback - GAS処理結果を受けた後続処理
 * @returns {void} なし
 *
 * @example <caption>使用例</caption>
      const res = fetchGAS({
        from     : 'inputSearchKey',
        to       : 'Master',
        func     : 'candidates',
        data     : {..},
        callback : r => {...},
      });
 */
const fetchGAS = (arg) => {
  console.log("fetchGAS start.",arg);

  // GASからの返信を受けたらcallbackを呼び出し
  fetch(config[arg.to].url,{
    "method": "POST",
    "body": JSON.stringify({
      key : config[arg.to].key,
      from: config.entryStr,
      to  : arg.to,
      func: arg.func,
      data: arg.data,
    }),
    "Accept": "application/json",
    "Content-Type": "application/json",
  }).then(response => response.json())
  .then(res => {
    console.log("fetchGAS end.",res);
    arg.callback(res);  // 成功した場合、後続処理を呼び出し
  });
}

/** genChild: テンプレートに差込データをセットした要素を生成
 *
 * @param {object} template - 生成対象となる要素のテンプレート
 * @param {string} template.tag      - タグ。既定値'div'
 * @param {string} template.children - 子要素。templateを再帰的に定義
 * @param {string} template.text - テキスト要素。'\t'の部分はvariableの値で置換
 * @param {string} template.skip - 「dObj[skip]=undefined⇒スキップ」の指定<br>例：参加者名が空欄なら名簿行を作成しない
 * @param {string} template.variable - テキスト要素の'\t'に埋め込むdObjの要素(ex.variable='名前'⇒dObj['名前'])
 * @param {string} template.max - 不定回数繰り返す場合、その最大を指定
 * @param {string} template.class - クラス名。三項演算子なら評価結果()
 * @param {string} template.id - setAttributeで設定
 * @param {string} template.type - setAttributeで設定
 * @param {string} template.name - setAttributeで設定
 * @param {string} template.value - setAttributeで設定
 * @param {string} template.accept - setAttributeで設定
 * @param {string} template.capture - setAttributeで設定
 * @param {string} template.width - setAttributeで設定
 * @param {string} template.height - setAttributeで設定
 * @param {string} template.style - setAttributeで設定
 * @param {string} template.onclick - location.hrefする場合の遷移先URL
 * @param {boolean} template.checked - trueならcheckedを追加
 * @param {string[]} template.opt - tag="select"の場合に作成されるoptions。variableの値が選択された状態になる
 * @param {object} dObj - 実データのオブジェクト
 * @param {string} pFP - パン屑リストの表示名
 *
 * @returns {object} 処理結果と生成されたノード
 * <ul>
 * <li>append {boolean} - 追加対象となる子要素ならtrue
 * <li>status {string} - 処理結果
 * <ul>
 * <li>'skipped' => テンプレートのskip条件を満たすため、生成を見送った子要素
 * <li>'variable' => テンプレートのtextが未指定なので、変数の値をそのままセット
 * <li>'replaced' => テンプレートのtext指定に基づき、プレースホルダ('\t')に変数の値をセット
 * <li>'fixed' => テンプレートのtext指定にプレースホルダがなく、textをそのままセット(固定文字列)
 * <li>'node' => セットする文字列が指定されていない要素(既定値)
 * </ul>
 * <li>result: 子要素のオブジェクト。エラー時はエラーオブジェクト
 * </ul>
 *
 * @example <caption>利用例</caption>
 * const template = [
 *   {tag:'div', class:'video', style:opt.video, children:[
 *     {tag:'video', style:'width:100%;'}]},
 *   {tag:'div', class:'camera', style:opt.camera, children:[
 *     {tag:'input', type:'file', accept:"image/*", capture:"camera", name:"file"}]},
 *   {tag:'div', class:'finder', style:opt.finder , children:[
 *     {tag:'canvas', style:'width:100%'},]},
 * ]
 * for( let i=0 ; i<template.length ; i++ ){
 *   let o = genChild(template[i],{},'root');  // 全体の定義と'root'を渡す
 *   if( toString.call(o.result).match(/Error/) ){  // エラーObjが帰ったら
 *     throw o.result;
 *   } else if( o.append ){  // 追加フラグがtrueなら親要素に追加
 *     scanner.appendChild(o.result);
 *   }
 * }
 */
const genChild = (template,dObj={},pFP='root') => {
  let rv = {append:true, status:'node', result:null};  // catch節でも使用する変数を、try節の前で宣言
  try {

    /* ========================================
      1.前処理
    ======================================== */
    // 1.1.テンプレートの定義(メンバ)がundefinedにならないよう初期値を設定し、
    //     'sDef'とする(structure definition)
    const sDef = {  // template.specにある、文書構造定義に使用される項目
      tag:'div', children:[], text:'', skip:'', variable:'', max:0,
      class:'', // 生成される要素(タグ)に指定する属性(現在classのみ)
      ...template  // 既定値を指定値で上書き
    };

    // 1.2.現在の位置を示すパンくずリスト文字列を生成(current foot print)
    const cFP = pFP + ' > '
      + (sDef.tag.length === 0 ? '(no tag)' : sDef.tag)
      + (sDef.class.length > 0 ? '.'+sDef.class : '');
    console.log('genChild start. cFP='+cFP+'\n'+JSON.stringify(sDef));

    // 1.3.内部関数の定義
    const addSeqNo = (cDef,no) => {
      if( cDef.skip && cDef.skip !== '' ) cDef.skip += '_' + no;
      if( cDef.variable && cDef.variable !== '' ) cDef.variable += '_' + no;
      if( cDef.children && cDef.children.length > 0 ){
        for( let i=0 ; i<cDef.children.length ; i++ )
          addSeqNo(cDef.children[i],no);
      }
    };

    // 1.4.作成不要ならスキップ
    // ①skip指定有り & ②実データに指定項目が存在 & ③実データの指定項目が空白
    if( sDef.skip.length > 0 && dObj[sDef.skip] && dObj[sDef.skip].length === 0 ){
      return {append:false, status:'skipped', result:null};
    }
    //console.log('l.490')

    /* ========================================
      2. 自要素の作成
    ======================================== */

    // 2.1.dObj[skip]が空なら作成不要
    if( sDef.skip.length > 0 ){
      console.log('l.176 dObj['+sDef.skip+']='+dObj[sDef.skip]
      + ', length='+String(dObj[sDef.skip]).length);
      if( dObj[sDef.skip] !== undefined ){
        if( String(dObj[sDef.skip]).length === 0 ){
          console.log('genChild skipped: '+cFP);
          return {append:false, status:'skipped', result:null};
        }
      }
    }

    // 2.2.中の文字列をstrとして作成
    let str = '';
    if( sDef.text.length === 0 ){ // sDef.text指定無し
      if( sDef.variable.length > 0 ){ // sDef.variable指定有り
        if( dObj[sDef.variable] !== undefined ){
          rv.status = 'variable';
          str = dObj[sDef.variable];  // 中の文字列はsDef.variable
        }
      }
    } else { // sDef.text指定有り
      if( sDef.text.match(/\t/) ){  // プレースホルダあり
        if( dObj[sDef.variable] !== undefined ){  // 変数指定もあり
          rv.status = 'replaced';
          str = sDef.text.replace(/\t/g,dObj[sDef.variable]);
        } // else -> プレースホルダが有っても変数指定が無ければ何もしない
      } else {  // プレースホルダなし
        rv.status = 'fixed';
        str = sDef.text;  // 中の文字列はsDef.textそのまま
      }
    }
    //console.log('l.523 str='+str);

    // 2.3.自要素(element)の生成
    if( sDef.tag.length > 0 ){
      rv.result = document.createElement(sDef.tag);
      if( str )
        rv.result.appendChild(document.createTextNode(str));
    } else {
      rv.result = document.createTextNode(str);
    }
    //console.log('l.532 rv',rv.result);

    // 2.4.自要素に属性を追加
    if( sDef.class && sDef.class.length > 0 ){
      /* sDef.classが三項演算子の場合、評価結果をクラスとする。 -> evalなので削除
        それ以外は文字列としてそのまま適用
      rv.result.className = sDef.class.match(/.+\?.+:.+/)
        ? eval(sDef.class) : sDef.class; */
      rv.result.className = sDef.class;
    }
    console.log('l.586',rv.result);
    ['id','type','name','value','accept','capture','width','height','style'].forEach(x => {
      if( sDef[x] && sDef[x].length > 0 ){
        rv.result.setAttribute(x,sDef[x]);
      }
    });
    if( sDef.onclick && dObj[sDef.onclick] ){
      // onclickの定義
      rv.result.setAttribute('onclick',dObj[sDef.onclick]);
      /* 旧：ボタンクリックで遷移
      rv.result.setAttribute('onclick',"location.href='_'".replace('_',dObj[sDef.onclick]));*/
    }
    if( sDef.checked && dObj[sDef.checked] ){
      // dObj[sDef.checked]がtrueならcheckedを追加
      rv.result.checked = true;
    }
    if( sDef.tag === 'select' ){  // select文の場合、子要素としてoptionを作成
      console.log('l.562 sDef='+JSON.stringify(sDef)+'\ndObj='+JSON.stringify(dObj));
      for( let i=0 ; i<sDef.opt.length ; i++ ){
        let opt = document.createElement('option');
        opt.value = sDef.opt[i];
        opt.appendChild(document.createTextNode(sDef.opt[i]));
        if( sDef.opt[i] === dObj[sDef.variable] ){
          opt.selected = true;
        }
        rv.result.appendChild(opt);
      }
    }
    //console.log('l.571 rv',rv.result);

    /* ========================================
      3. 子要素の作成
    ======================================== */
    for( let i=0 ; i<(sDef.max === 0 ? 1 : sDef.max) ; i++ ){
      const cDef = JSON.parse(JSON.stringify(sDef));
      if( cDef.max > 0 )
        addSeqNo(cDef,i);  // 不定項目の場合、子孫全部ラベルを書き換え
      for( let j=0 ; j<cDef.children.length ; j++ ){
        const o = genChild(cDef.children[j],dObj,cFP);
        if( o.append ) rv.result.appendChild(o.result);
      }
    }
    //console.log('l.585 rv',rv.result);

    /* ========================================
      5. 結果表示して作成した要素を返す
    ======================================== */
    console.log('genChild end: '+cFP+'\n',rv);
    return rv;

  } catch(e) {
    console.error(e.message);
    return rv;
  }
};

/** sha256: テキストをsha256でハッシュ化
 *
 * @param {string} text - 暗号化対象のテキスト
 * @param {function} callback - 作成後の後続処理
 *
 * @returns {void} なし
 */
function sha256(text,callback){
  const sha = async (text) => {
    const uint8  = new TextEncoder().encode(text)
    const digest = await crypto.subtle.digest('SHA-256', uint8)
    return Array.from(new Uint8Array(digest)).map(v => v.toString(16).padStart(2,'0')).join('')
  }
  sha(text).then((hash) => callback(hash));
}
// :: page "library" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "menu" Script section start. ::::::::::::::::::::::::::::::::::::::
/** class Menu: メニュー表示、制御 */
class Menu {
  constructor(){
    console.log('Menu.constructor start.');
    this.dom = {
      icon: document.querySelector('header .menuIcon'),
      nav: document.querySelector('nav'),
    };
    this.status = true; // メニューが開いている状態ならtrue
    this.closeMenu();

    // メニューの定義
    this.menuObj = {  // flag=0 -> メニュー以外から誘導される画面
      messageBoard: {title:'お知らせ', flag:3},
      reception: {title:'受付業務', flag:28},
      paperForm: {title:'用紙による申請登録', flag:0},
      applicationQR: {title:'参加申請フォームへの誘導', flag:0},
      cornerOperation: {title:'コーナー運営', flag:32},
      entry: {title:'参加受付', flag:192},
      referState: {title:'予約状況参照', flag:768},
      information: {title:'お役立ち情報', flag:7168},
      enquete: {title:'参加者アンケート', flag:8192},
      system: {title:'システム設定', flag:49152}
    }
    //console.log('l.97 config.private.menuFlags='+config.private.menuFlags);
    Object.keys(this.menuObj).forEach(x => {
      if( this.menuObj[x].flag > 0 ){
        // config.private.menuFlagsで指定されたメニューのみ追加
        const li = this.dom.nav.querySelector('li[name="'+x+'"]');
        //console.log('l.101 x='+JSON.stringify(x));
        if( (this.menuObj[x].flag & config.private.menuFlags) === 0 ){
          li.classList.add('hide');
        } else {
          li.classList.remove('hide');
          li.addEventListener('click',() => {
            this.closeMenu();
            this.changeScreen();
          });
        }
      }
    });
    this.changeScreen('messageBoard');
    console.log('Menu.constructor end.');
  }

  /** closeMenu: 開いているメニューを閉じる
   * @param {void} - なし
   * @returns {void} なし
   */
  closeMenu = () => {
    console.log('Menu.closeMenu start');
    if( this.status === false ){  // 既に閉じているなら何もしない
      return;
    }
    this.dom.icon.innerHTML = '<img src="img/menu1.svg" />';
    this.dom.icon.querySelector('img').onclick = this.openMenu;
    this.dom.nav.classList.add('hide');
    this.status = false;
    console.log('Menu.closeMenu end');
  }

  /** openMenu: 閉じているメニューを開く
   * @param {void} - なし
   * @returns {void} なし
   */
  openMenu = () => {
    console.log('Menu.openMenu start');
    if( this.status === true ){   // 既に開いているなら何もしない
      return;
    }
    this.dom.icon.innerHTML = '<img src="img/menu2.svg" />';
    this.dom.icon.querySelector('img').onclick = this.closeMenu;
    this.dom.nav.classList.remove('hide');
    this.status = true;
    console.log('Menu.openMenu end');
  }

  /** changeScreen: 指定画面への変更
   * @param {string} screenId - this.menuObjのメンバ名
   * @returns {void} なし
   */
  changeScreen = (screenId) => {
    // メニューからクリックされた場合、name属性をscreenIdとする
    if( !screenId ){
      screenId = window.event.target.attributes.name.value;
    }
    console.log('Menu.changeScreen start. screenId='+screenId);

    // タイトルの表示
    document.querySelector('header .title').innerText = this.menuObj[screenId].title;

    // main直下の全DIVに対して、指定screenIdなら表示・それ以外は非表示
    document.querySelectorAll('.screen').forEach(x => {
      if( x.classList.contains(screenId) ){
        x.classList.remove('hide');
        // 表示の際、何らかの処理が必要な場合は実行
        if( config[screenId] && config[screenId].display ){
          config[screenId].display();
        }
      } else {
        x.classList.add('hide');
      }
    });

    console.log('Menu.changeScreen end.');
  }

  /** changeArea: 指定画面内の表示領域を変更
   * @param {string} screenId - this.menuObjのメンバ名
   * @param {string} areaId - screenIdクラス内の領域のクラス名
   * @returns {void} なし
   */
  changeArea = (screenId, areaId) => {
    // 指定画面以下のareaクラスを持つ全ての要素に対して、
    // 指定areaIdなら表示・それ以外は非表示
    document.querySelectorAll('.'+screenId+' .area').forEach(x => {
      if( x.classList.contains(areaId) ){
        x.classList.remove('hide');
      } else {
        x.classList.add('hide');
      }
    });
  }
}

// :: page "menu" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "authorize" Script section start. ::::::::::::::::::::::::::::::::::::::
/** class Auth: クライアント側の認証 */
class Auth {
  /** constructor: 認証画面の生成
   * @param {function} callback - 認証成功後の処理。既定値：何もしない
   * @returns {void} なし
   */
  constructor(callback=()=>{}){
    this.callback = callback; // getPassCode終了後に呼び出し
    this.dom = {
      entryNo: document.querySelector('.authorize .entryNo'),
      passCode: document.querySelector('.authorize .passCode'),
    }
    this.dom.entryNo.querySelector('input[type="button"]').onclick = this.getEntryNo;
    this.dom.passCode.querySelector('input[type="button"]').onclick = this.getPassCode;

    // デバッグ時はテスト用configセット後、後処理を実行
    if( config.debugMode > 0 ){
      this.setTestData(config.debugMode);
      this.callback();
    }
  }

  /** getEntryNo: 受付番号を入力、認証局に問合せ
   * @param {void} - なし
   * @returns {void} - なし
   */
  getEntryNo = () => {
    console.log('Auth.getEntryNo start.');

    // 受付番号のボタンを不活性化
    this.dom.entryNo.querySelector('input[type="button"]').disabled = 'disabled';
    // メッセージ設定
    this.dom.entryNo.querySelector('.message').innerHTML = '<p>暫くお待ちください...</p>';

    const inputValue = this.dom.entryNo.querySelector('input[type="text"]').value;
    // 受付番号が適切かチェック、不適切なら処理中断
    if( !inputValue.match(/^[0-9]{1,4}$/) ){
      alert("不適切な受付番号です");
      // 入力欄をクリア
      this.dom.entryNo.querySelector('input[type="text"]').value = '';
      // 受付番号のボタンを活性化
      this.dom.entryNo.querySelector('input[type="button"]').disabled = null;
      return;
    }

    config.entryNo = Number(inputValue);
    config.entryStr = ('000'+config.entryNo).slice(-4);
    const res = fetchGAS({
      to       : 'Auth',
      func     : 'auth1A',
      data     : config.entryNo,
      callback : (response) => {
        console.log('getEntryNo response = '+JSON.stringify(response));
        if( response.isErr ){
          const d = this.dom.entryNo.querySelector('.message');
          d.innerHTML = '';
          for( let i=0 ; i<response.faild.length ; i++ ){
            d.innerHTML = d.innerHTML + '<p class="error">'
              + response.faild[i].recipient + ' : '
              + response.faild[i].message + '</p>';
          }
        } else {
          // 受付番号入力欄を隠蔽
          this.dom.entryNo.classList.add('hide');
          // パスコード入力画面を開く
          this.dom.passCode.classList.remove('hide');
        }
      },
    });
    console.log('Auth.getEntryNo end. res='+JSON.stringify(res));
  }

  /** getPassCode: パスコード入力
   * @param {void} - なし
   * @returns {void} なし
   */
  getPassCode = () => {
    console.log('Auth.getPassCode start');

    // パスコードのボタンを不活性化
    this.dom.passCode.querySelector('input[type="button"]').disabled = 'disabled';

    // パスコードの形式が適切かチェック、	不適切なら処理中断
    const inputValue = this.dom.passCode.querySelector('input[type="text"]').value;
    if( !inputValue.match(/^[0-9]{6}$/) ){
      alert("不適切なパスコードです");
      // 入力欄をクリア
      this.dom.passCode.querySelector('input[type="text"]').value = '';
      // パスコードのボタンを活性化
      this.dom.passCode.querySelector('input[type="button"]').disabled = null;
      return;
    }

    const rv = fetchGAS({
      to: 'Auth',
      func: 'auth2A',
      data: {entryNo:config.entryNo, passCode:inputValue},
      callback: (response) => {
        console.log('getPassCode response = '+JSON.stringify(response));
        if( response.isErr ){
          this.dom.passCode.querySelector('.message').innerHTML
            = '<p class="error">' + response.message + '</p>';
        } else {
          // configの内容を更新
          for( let x in response.config ){
            if( whichType(response.config[x]) === 'Object' ){
              if( config[x] === undefined ){
                config[x] = {};
              }
              for( let y in response.config[x] ){
                config[x][y] = response.config[x][y];
              }
            } else {
              config[x] = response.config[x];
            }
          }
          this.dom.main.innerHTML = ''; // 主表示域をクリア
          console.log('config='+JSON.stringify(config));
          // 後処理を呼び出す
          this.callback(response);
        }
      }
    });

    console.log('Auth.getPassCode end');
  }

  /** setTestData: debugModeに従ってconfigに値を設定
   * @param {number} debugMode - 0:通常, 1:スタッフ, 2:参加者
   * @returns {void} なし
   */
  setTestData = (debugMode) => {
    console.log('Auth.setTestData start. debugMode='+debugMode);

    const testdata = {

      // config.jsonのコピー。適宜最新のものに書き換えすること。
      "Auth": {   // 認証局
        "level": 1,
        // 認証局は誰でもアクセス可なので、key は設定しない
        "key": "",  // undefinedにならないよう設定するダミー
        "url": "https://script.google.com/macros/s/AKfycbzjsxwmNmR9TV2wswNuUVZDOUIOYVGNGiA02hh74_BwNTzArExR21wVPYFOSLdBNe67BQ/exec"
      },
      "Broad": {  // 放送局
        "level": 2,
        "key": "xGq8kdob7NQXvCG3Jbcil9K-q9HIgJgUO727BfptbUIZXvFX05uJB0CSZHVMb",
        "url": "https://script.google.com/macros/s/AKfycbwUDcopeh6yAFR9_EAb5uMPVMBUZGkROOOgcttKyhy_PS1jGMakxO4lRGUtPVDLfNLdZQ/exec"
      },
      "Reserve": { // 予約局
        "level": 4
      },
      "Master": { // 管理局
        "level": 8,
        "key": "_WGbHipKdOeuFydHpbz2yzjBmnFNqHYuhAvyMy1QcX5BQgyLl",
        "url": "https://script.google.com/macros/s/AKfycbzuKbQ053i_x6RrkkIqBwNcmvRg4tEQCOFvIPjDlVtajDy7i4LzkVS3YtyI2LhpjkJ32w/exec",
        "validTime": 3600000  // パスコードの有効時間。ミリ秒
      },
      "Post": {   // 郵便局
        "level": 16,
        "key": "hZ8QEXviiBdU_PfGlZrnIuHODkb6-vY8wx4_azvBd2vbOEEAS3xxI",
        "url": "https://script.google.com/macros/s/AKfycbw1BZqob_P6SnIW3dDQrzDTZtt0Z9de60wiHhw94k7gbLFYdThmHyUeS8ATmqd2z_etbw/exec"
      },
      "Agency": {  // 資源局
        "level": 32,
        "key": "IptLc8AbphZ8QEXviiBdU_PfGvCG3Jbcil9lZrnIuHO",
        "url": "https://script.google.com/macros/s/AKfycbyNBetqxnZoHQee3vrApYJUXIyty2YdeuQfPpZVKgOko8IwJU8gKjCm0G4lu_qF-vo/exec",
        "overhead": 140 // ログを書き込む際に発生する想定オーバーヘッド。ミリ秒
      },
      "public": {    // 公開情報
        "level": 65535,
        "interval": 30000, // 定期配信の間隔。ミリ秒
        "Administrator":  // システム管理者のメールアドレス
          "shimokitasho.oyaji@gmail.com",
        "FormId":
          "1hnQLsY3lRh0gQMGfXoJJqAL_yBpKR6T0h2RFRc8tUEA",
        "FormURL":  // 参加申請受付フォーム。当日参加を誘導するのに使用
          "https://docs.google.com/forms/d/e/1FAIpQLSfIJ4IFsBI5pPXsLz2jlTBczzIn8QZQL4r6QHqxZmSeDOhwUA/viewform",
        "SiteURL": // イベント案内サイト。実施・募集要領他を掲載したサイト
          "https://sites.google.com/view/shimokita-oyaji/home/archives/20221001-%E6%A0%A1%E5%BA%AD%E3%83%87%E3%82%A4%E3%82%AD%E3%83%A3%E3%83%B3%E3%83%97",
        "MapURL": // イベント会場マップ。GitHubのmaterialsディレクトリに保持
          "materials/map.html",
        "TableURL": // タイムテーブル(進行予定表)。GitHubのmaterialsに保持
          "materials/timetable/WBS.html",
        "EnqueteURL":  // 参加者アンケート
          "https://docs.google.com/forms/d/16r3luYQRiLVmI9xqaD4FuaSlUqTRGvI8nAGrjGcg8lc/viewform"
      },

      // Agentは資源局からコピー
      "Agent": {
        key:"pSp2*ZR_S/GXr9C5",
        url:"https://script.google.com/macros/s/AKfycbyJDT4rTHPPY6BP2DW4LVZLR3ozzb13ROJ9zvuLrb7cM2V7AaYTLlDICYwKnWhSC-mD/exec"
      },

      // Privateは開発モード画面からコピー。または管理局のシートから。
      "staff":{
        "タイムスタンプ":"2022-10-09T04:34:42.211Z",
        "メールアドレス":"shimokitasho.oyaji@gmail.com",
        "申請者氏名":"奥田　美香",
        "申請者氏名読み":"オクダ　ミカ",
        "申請者はイベントに参加しますか？":"参加する",
        "参加者①氏名":"太郎",
        "参加者①氏名読み":"タロウ",
        "参加者①所属":"未就学児",
        "参加者②氏名":"二郎",
        "参加者②氏名読み":"ジロウ",
        "参加者②所属":"1年",
        "参加者③氏名":"",
        "参加者③氏名読み":"",
        "参加者③所属":"",
        "緊急連絡先":"",
        "引取者氏名":"",
        "備考":"",
        "キャンセル":"",
        "cancel":"1",
        "participate00":"1",
        "entryNo":"1",
        "editURL":"https://docs.google.com/forms/d/e/1FAIpQLSfIJ4IFsBI5pPXsLz2jlTBczzIn8QZQL4r6QHqxZmSeDOhwUA/viewform?edit2=2_ABaOnufCYALGfSCCaKbN4LDLlq9n6oTS8MfbMXvMVGeqH9hcsqj47n1z3eUW-muVZIhFFjg",
        "application":"",
        "PIC":"",
        "passCode":"27467",
        "passTime":"2022-12-06T06:06:51.655Z",
        "manualMF":"57119",
        "menuFlags":"57119",
        "manualAL":"14",
        "AuthLevel":"14",
        "name00":"奥田　美香",
        "yomi00":"オクダ　ミカ",
        "category00":"保護者",
        "status00":"",
        "fee00":"",
        "name01":"太郎",
        "yomi01":"タロウ",
        "category01":"未就学児",
        "status01":"",
        "fee01":"",
        "name02":"二郎",
        "yomi02":"ジロウ",
        "category02":"1年",
        "status02":"",
        "fee02":"",
        "name03":"",
        "yomi03":"",
        "category03":"",
        "status03":"",
        "fee03":""
      },
      "participant":{
        "タイムスタンプ":"2022-10-09T04:39:20.911Z",
        "メールアドレス":"shimokitasho.oyaji@gmail.com",
        "申請者氏名":"榎田　道子",
        "申請者氏名読み":"エノキダ　ミチコ",
        "申請者はイベントに参加しますか？":"参加する",
        "参加者①氏名":"",
        "参加者①氏名読み":"",
        "参加者①所属":"",
        "参加者②氏名":"",
        "参加者②氏名読み":"",
        "参加者②所属":"",
        "参加者③氏名":"",
        "参加者③氏名読み":"",
        "参加者③所属":"",
        "緊急連絡先":"",
        "引取者氏名":"",
        "備考":"",
        "キャンセル":"",
        "cancel":"1",
        "participate00":"1",
        "entryNo":"2",
        "editURL":"https://docs.google.com/forms/d/e/1FAIpQLSfIJ4IFsBI5pPXsLz2jlTBczzIn8QZQL4r6QHqxZmSeDOhwUA/viewform?edit2=2_ABaOnucIuwg3VQQ89wjGMjOrBzL9Ko6Yd_-VRLBvabY6pcLfvOC1MGlrA29XPym2rtomwwQ",
        "application":"",
        "PIC":"",
        "passCode":"469555",
        "passTime":"2022-12-06T06:09:22.880Z",
        "manualMF":"",
        "menuFlags":"32449",
        "manualAL":"",
        "AuthLevel":"4",
        "name00":"榎田　道子",
        "yomi00":"エノキダ　ミチコ",
        "category00":"保護者",
        "status00":"",
        "fee00":"",
        "name01":"",
        "yomi01":"",
        "category01":"",
        "status01":"",
        "fee01":"",
        "name02":"",
        "yomi02":"",
        "category02":"",
        "status02":"",
        "fee02":"",
        "name03":"",
        "yomi03":"",
        "category03":"",
        "status03":"",
        "fee03":""
      },

    };

    // スタッフ・参加者共通パラメータ
    const common = {
      "Auth":{"url":testdata.Auth.url},
      "Reserve":{"level":4},
      "public":testdata.public,
      "Agent":testdata.Agent
    }

    // スタッフ・参加者それぞれの特有パラメータ
    const peculiar = debugMode === 1 ? {
      "entryNo":1,
      "entryStr":"0001",
      "private":testdata.staff,
      "Broad":{"level":2,"key":testdata.Broad.key,"url":testdata.Broad.url},
      "Master":{"level":8,"key":testdata.Master.key,"url":testdata.Master.url,"validTime":3600000},
    } : {
      "entryNo":2,
      "entryStr":"0002",
      "private":testdata.participant,
    }

    // configに値をセット
    Object.keys(common).forEach(x => {config[x] = common[x];});
    Object.keys(peculiar).forEach(x => {config[x] = peculiar[x];});

    console.log('Auth.setTestData end.',config);
  }

}
// :: page "authorize" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "messageBoard" Script section start. ::::::::::::::::::::::::::::::::::::::
/** messageBoard: お知らせへの投稿、配信 */
class messageBoard {

  /** constructor: お知らせ画面の設定 */
  constructor(){
    this.dom = {
      title: document.querySelector('header .title'),
      main: document.querySelector('.messageBoard'),
      postArea: document.querySelector('.messageBoard .postArea'),
      postButton: document.querySelector('.messageBoard .postButton input'),
      broadArea: document.querySelector('.messageBoard .broadArea'),
    };
    this.posts = [];
    this.lastUpdate = getJPDateTime('1901/01/01');
    this.startTime = new Date();
    this.intervalId = null;

    // 1. 投稿権限がある場合は投稿エリアを表示
    if( (config.private.menuFlags & 2) > 0 ){
      this.dom.postButton.addEventListener('click',() => {
        if( this.dom.postButton.value === '投稿する' ){
          this.dom.postButton.value = '閉じる';
          this.dom.postArea.classList.remove('hide');
        } else {
          this.dom.postButton.value = '投稿する'
          this.dom.postArea.classList.add('hide');
        }
      });
    }

    this.display(); // 掲示板を表示
    this.start();   // 定期更新を開始
  }

  /** display: 掲示板の表示
   * @param {void} - なし
   * @returns {void} なし
   */
  display(){
    this.dom.title.innerText = 'お知らせ';
    // 1.投稿権限がある場合は投稿エリアを表示
    if( (config.private.menuFlags & 2) > 0 ){
      // 二回目以降の投稿ではハンドルネームをセット
      if( config.handleName ){
        this.dom.main.querySelector('input[name="from"]').value = config.handleName;
      }
    }

    // 2.投稿内容の表示
    // 2.1.新規のお知らせが来たら末尾を表示するよう設定
    // https://at.sachi-web.com/blog-entry-1516.html
    const mo = new MutationObserver(() => {
      console.log('mutation detected');
      this.dom.broadArea.scrollTop = this.dom.broadArea.scrollHeight;
    });
    mo.observe(this.dom.broadArea,{
      childList: true,
      attributes: true,
      characterData: true,
      subtree: true,//孫以降のノードの変化も検出
      attributeOldValue: true,//変化前の属性データを記録する
      characterDataOldValue: true,//変化前のテキストノードを記録する
      attributeFilter: [],//配列で記述した属性だけを見張る
    });

    // 2.2.時系列にメッセージを並べ替え
    this.posts.sort((a,b) => a.timestamp < b.timestamp);

    // 2.3.掲示板領域に書き込むHTMLを msg として作成
    let msg = '';
    let lastMesDate = '1900/01/01';  // 投稿日が変わったら日付を表示するよう制御
    const t = '<p class="title">[_time] From:_from　To:_to</p><p>_message</p>';
    for( let i=0 ; i<this.posts.length ; i++ ){
      const dt = new Date(this.posts[i].timestamp);
      if( dt.toLocaleDateString('ja-JP') !== lastMesDate ){
        lastMesDate = dt.toLocaleDateString('ja-JP');
        msg += '<p class="date">' + lastMesDate + '</p>';
      }
      const hms = ('0'+dt.getHours()).slice(-2)
        + ':' + ('0'+dt.getMinutes()).slice(-2)
        + ':' + ('0'+dt.getSeconds()).slice(-2);
      const m = t.replace('_time',hms)
        .replace('_from',this.posts[i].from)
        .replace('_to',this.posts[i].to)
        .replace('_message',this.posts[i].message)
        .replace(/\n/g,'<br>');
      //console.log('m='+m);
      msg += m;
    }
    // 2.4.掲示板領域に書き込み
    const msgEl = this.dom.main.querySelector('div.broadArea');
    msgEl.innerHTML = msg;
    msgEl.scrollIntoView(false);
  }

  /** getMessages: メッセージの受信、掲示板への表示
   * @param {void} - なし
   * @returns {void} なし
   */
  getMessages(){
    console.log('getMessages start.');
    // 現在表示中の画面が「お知らせ」でなければ受信・表示とも行わない
    if( this.dom.title.innerText !== 'お知らせ' ){
      return;
    }

    /* 配信局へ配信要求
    * @param {string}   arg.to       - 受信側のコード名(平文)
    * @param {string}   arg.func     - GAS側で処理分岐の際のキー文字列
    * @param {any}      arg.data     - 処理対象データ
    * @param {function} arg.callback - GAS処理結果を受けた後続処理 */
    fetchGAS({
      to: 'Agent',
      func: 'castMessages',
      data: this.lastUpdate,
      callback: (res) => {
        console.log('getMessages res='+JSON.stringify(res));
        if( !res.isErr ){
          this.posts = this.posts.concat(res.posts);
          const map = res.posts.map(x => new Date(x.timestamp).getTime());
          //console.log('map='+JSON.stringify(map));
          const mapMax = map.reduce((a,b)=>{return Math.max(a,b)},-Infinity);
          //console.log('mapMax='+mapMax);
          this.lastUpdate = new Date(mapMax);
          this.display();
        }
        //console.log('getMessages lastUpdate='+getJPDateTime(this.lastUpdate)
        //  +'\nposts='+JSON.stringify(this.posts));
      }
    });

  }

  /** postMessage: メッセージを投稿
   * @param {void} - なし
   * @returns {void} なし
   */
  postMessage(){
    console.log('postMessage start.');
    config.handleName = this.dom.main.querySelector('[name="from"]').value;
    const toEl = this.dom.main.querySelector('[name="to"]');

    fetchGAS({
      to: 'Broad',
      func: 'postMessage',
      data: {
        timestamp: getJPDateTime(),
        from: config.handleName,
        to: toEl.options[toEl.selectedIndex].value,
        message: this.dom.main.querySelector('[name="message"]').value,
      },
      callback: (res) => {
        this.getMessages();  // 掲示板を更新
        console.log('postMessage end. res='+JSON.stringify(res));
      }
    });
  }

  /** start: 定期的処理の開始
   * @param {void} - なし
   * @returns {void} なし
   */
  start(){
    this.getMessages();
    // スリープ時間も含め一定時間毎に実行
    // https://blog-and-destroy.com/28211
    this.intervalId = setInterval(() => {
      if( Date.now() > (this.startTime + config.public.interval - 500) ){
        this.getMessages();
        this.startTime = Date.now();
      }
    },config.public.interval);
    console.log('messageBoard.start. interval=' + config.public.interval);
  }

  /** stop: 定期的処理の停止
   * @param {void} - なし
   * @returns {void} なし
   */
  stop(){
    clearInterval(this.intervalId);
    this.intervalId = null;
    console.log('messageBoard.end');
  }
}
// :: page "messageBoard" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "reception" Script section start. ::::::::::::::::::::::::::::::::::::::
class Reception {

  constructor(){
    config.menu.changeArea('reception','receptionMain');
    this.dom = {
      main: document.querySelector('.reception'),
      title: document.querySelector('header .title'),
      scanner: document.querySelector('.reception .scanner'),
      edit: document.querySelector('.reception .edit'),
    };
    // スキャナのセットアップ
    this.scanner = new webScanner({
      /* @param {object} arg.parent - 親要素
      * @param {number} arg.interval - 動画状態で撮像、読み込めなかった場合の時間間隔
      * @param {object} arg.RegExp - QRコードスキャン時、内容が適切か判断
      * @param {boolean} arg.alert - 読み込み完了時に内容をalert表示するか */
      parent: this.dom.main.querySelector('.scanner'),
      interval: 0.25,
    });
  }

  /** display: 受付業務画面の表示
   * @param {void} - なし
   * @returns {void} なし
   * 本処理は読込直後のみならず、受付業務画面表示の都度行う必要があるため、
   * constructorではなくdisplayで定義する。
   */
  display(){
    config.menu.changeArea('reception','receptionMain');
    this.scanner.scanQR((code)=>{  // QRコード読込後の処理
      console.log('scanned => '+code);
      this.searchKey(code);
    },{
      RegExp: /^[0-9]+$/,
      alert: true
    });
  }

  /** searchKey: 検索キー(受付番号または氏名の一部)で検索
   * @param {string|undefined} - 検索キーとなる受付番号または氏名の一部
   * @returns {object} 検索結果のオブジェクト
   * <ul>
   * <li>isErr {boolean} - エラーならtrue
   * <li>message {string} - エラーの場合はメッセージ。正常終了ならundefined
   * <li>result {object[]} - 検索キーにマッチした申込の配列。[{項目名:値,..},{..},..]形式
   * </ul>
  */
  searchKey(arg=''){
    console.log('reception.search start. arg='+JSON.stringify(arg));
    config.menu.changeArea('reception','searching');

    /* fetchGAS
    * @param {object}   arg          - 引数
    * @param {string}   arg.to       - 受信側のコード名(平文)
    * @param {string}   arg.func     - GAS側で処理分岐の際のキー文字列
    * @param {any}      arg.data     - 処理対象データ
    * @param {function} arg.callback - GAS処理結果を受けた後続処理 */
    fetchGAS({
      to: 'Master',
      func: 'candidates',
      data: arg.length > 0 ? arg : this.dom.keyWordArea.value,
      callback: (res => {
        if( res.isErr ){
          document.querySelector('.reception .error p').innerText = res.message;
          return;
        } else {
          if( res.result.length === 0 ){
            alert("該当する参加者は存在しませんでした");
            this.display();
          } else if( res.result.length > 1){
            this.selectParticipant(res.result);  // 該当が複数件なら選択画面へ
          } else {
            this.editParticipant(res.result[0]);  // 該当が1件のみなら編集画面へ
          }
        }
      })
    });
  }

  /** selectParticipant: 複数検索結果からの選択
   * @param {object[]} arg - 候補者のオブジェクトの配列。[{項目名:値,..},{..},..]形式
   * @returns {void} なし
   */
  selectParticipant(arg){
    console.log('selectParticipant start. arg='+JSON.stringify(arg));
    this.dom.title.innerText = '対象者の選択';
    config.menu.changeArea('reception','select');
    try {
      const editArea = this.dom.main.querySelector('.select');
      editArea.innerHTML = '<p>検索結果が複数あります。選択してください。</p>';
      for( let i=0 ; i<arg.length ; i++ ){
        const o = document.createElement('div');
        o.innerText = arg[i]['氏名'] + '(' + arg[i]['読み'] + ')';
        o.addEventListener('click',() => {
          editParticipant(arg[i]);  // 選択後編集画面へ
        });
        editArea.appendChild(o);
      }
      console.log('selectParticipant end.');
    } catch(e) {
      console.error('selectParticipant abnormal end.\n'+e.message);
      alert(e.message);
    }
  }

  /** editParticipant: 検索結果の内容編集
   * @param {object} - 編集対象のオブジェクト。{項目名:値,..}形式
   * @returns {void} なし
   */
  editParticipant(arg){
    console.log('editParticipant start. arg='+JSON.stringify(arg));
    this.dom.title.innerText = '参加者情報の編集';
    config.menu.changeArea('reception','edit');
    try {
      this.entryNo = arg.entryNo;  // 更新時に利用
      const applicant = this.dom.edit.querySelector('.edit > div.applicant');
      const details = this.dom.edit.querySelector('.edit > div.details');
      const members = this.dom.edit.querySelector('.edit > div.members');
      const result = this.dom.edit.querySelector('.edit > div.result');

      // 01.申込概要
      // 01.1 空欄・読替処理
      applicant.querySelector('.entryNo').innerText = config.entryStr;
      applicant.querySelector('rb').innerText = arg.name00;
      applicant.querySelector('rt').innerText = arg.yomi00;
      // 01.2 イベントリスナの定義
      // 「詳細」ボタンクリック
      let btn = applicant.querySelector('button[name="details"]');
      btn.addEventListener('click',() => {
        if( btn.textContent === '詳細' ){
          details.classList.remove('hide');
          btn.textContent = '閉じる';
        } else {
          details.classList.add('hide');
          btn.textContent = '詳細';
        }
      });

      // 02.申込詳細
      // 02.1 空欄・読替処理
      arg['タイムスタンプ'] = getJPDateTime(arg['タイムスタンプ']);
      arg.cancel = arg.cancel < 0 ? "取消済" : "( — )";
      details.querySelector('.timestamp').innerText = arg['タイムスタンプ'];
      details.querySelector('.email').innerText = arg['メールアドレス'];
      details.querySelector('.tel').innerText = arg['緊急連絡先'];
      details.querySelector('.pickup').innerText = arg['引取者氏名'];
      details.querySelector('.note').innerText = arg['備考'];
      details.querySelector('.cancel').innerText = arg['cancel'];
      let qrcode = new QRCode(details.querySelector('.qrcode'),{
        text: config.private.editURL,
        width: 200,
        height: 200,
        colorDark : "#000000",
        colorLight : "#ffffff",
        correctLevel : QRCode.CorrectLevel.H
      });
      
      // 03.参加者リスト(状態・参加費)
      // 03.1 空欄・読替処理
      for( let i=0 ; i<4 ; i++ ){
        const num = ('0'+i).slice(-2);
        if( arg['status'+num].length === 0 ){
          arg['status'+num] = arg['name'+num].length === 0 ? '未登録' : '未入場';
        }
        if( arg['fee'+num].length === 0 ){
          arg['fee'+num] = arg['name'+num].length === 0 ? '無し' : '未収';
        }
      }
      // 03.2 イベントリスナの定義
      // 「更新」ボタンクリック
      members.querySelector('button[name="update"]').addEventListener('click',() => {
        this.updateParticipant();
      });
      // 「取消」ボタンクリック
      members.querySelector('button[name="cancel"]').addEventListener('click',() => {
        this.display();
      });
      // 03.3 プルダウン項目が現状を表示するよう設定
      for( let i=0 ; i<4 ; i++ ){
        members.querySelector('.n0'+i+' .name').innerText = arg['name0'+i];
        ['status0','fee0'].forEach(x => {
          const n = x + String(i);
          const o = members.querySelector('select[name="'+n+'"]');
          for( let j=0 ; j<o.options.length ; j++ ){
            if( o.options[j].value === arg[n] ){
              o.selectedIndex = j;
              break;
            }
          }
        });
      }

      // 04.更新結果表示
      // 04.1 空欄・読替処理
      // 04.2 イベントリスナの定義
      result.querySelector('button').addEventListener('click',() => {
        this.display();
      });

      console.log('editParticipant end.');

    } catch(e) {
      console.error('editParticipant abnormal end.\n'+e.message);
      alert(e.message);
    }
  }

  /** updateParticipant: 参加者情報更新
   * @param {void} - なし
   * @returns {void} なし
   */
  updateParticipant(){
    console.log('updateParticipant start.');
    try {

      // 01.更新用のデータオブジェクトの作成
      const data = {};
      for( let i=0 ; i<4 ; i++ ){
        const num = ('0'+i).slice(-2);
        const s = this.dom.main.querySelector('select[name="status'+num+'"]');
        data['status'+num] = s.options[s.selectedIndex].value;
        const f = this.dom.main.querySelector('select[name="fee'+num+'"]');
        data['fee'+num] = f.options[f.selectedIndex].value;
      }
      //console.log('l.395 data='+JSON.stringify(data));

      // 02.スプレッドシートの更新
      /* @param {string}   arg.to       - 受信側のコード名(平文)
      * @param {string}   arg.func     - GAS側で処理分岐の際のキー文字列
      * @param {any}      arg.data     - 処理対象データ
      * @param {function} arg.callback - GAS処理結果を受けた後続処理 */
      fetchGAS({
        to: 'Master',
        func: 'updateParticipant',
        data: {
          data: data,
          opt: {key:'entryNo',value:this.entryNo}
        },
        callback: (res) => {
          /* 03.更新結果の表示
            * <li>isErr {boolean} - エラーならtrue
            * <li>message {string} - エラーメッセージ
            * <li>result {object[]} - 更新結果。空なら変更なし
            * <ul>
            * <li>column {string} - 更新した項目名
            * <li>before {any} - 修正前の値
            * <li>after {any} - 修正後の値 */
          const result = this.dom.edit.querySelector('.result');
          result.classList.remove('hide');
          const msg = result.querySelector('p');
          let message = '';
          if( res.isErr ){
            msg.classList.add('error');
            msg.innerText = res.message;
          } else if( res.result.length === 0 ){
            msg.innerText = '変更はありませんでした。';
          } else {
            msg.innerText = '更新が終了しました。';
          }
          console.log('updateParticipant end.\n'+JSON.stringify(res));
        }
      });

    } catch(e) {
      console.error(e.message);
      alert(e.message);
    }
  }
}
// :: page "reception" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "paperForm" Script section start. ::::::::::::::::::::::::::::::::::::::
class PaperForm {
  constructor(){
    this.dom = {
      step1: document.querySelector('.paperForm .step1'),
      step2: document.querySelector('.paperForm .step2'),
    }
    this.dom.step1.querySelector('button').addEventListener('click', ()=>{
      this.getEntryNo();
    });
  }

  display(){
    config.menu.changeArea('paperForm','step1');
  }

  /** 受付番号を取得してスキャン画面を表示する
   * @param {void} - なし
   * @returns {void} なし
   */
  getEntryNo(){
    console.log('PaperForm.getEntryNo start');
    // 入力された内容をGAS.Masterに送信
    // GAS.Master側で採番された受付番号を表示
    console.log('PaperForm.getEntryNo end');
  }

  /** scanForm: 紙申請用紙を撮影し、登録する
   * @param {void} - なし
   * @returns {void} なし
   */
  scanForm(){
    console.log('PaperForm.scanForm start');
    config.menu.changeArea('paperForm','step2');
    // スキャナで申請用紙を撮影
    // GAS.Masterに撮影された申請用紙を登録
    console.log('PaperForm.scanForm end');
  }
}
// :: page "paperForm" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "applicationQR" Script section start. ::::::::::::::::::::::::::::::::::::::
class ApplicationQR {
  constructor(){
    let qrcode = new QRCode(document.querySelector('.applicationQR .qrcode'),{
      text: config.public.FormURL,
      width: 300,
      height: 300,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    })
  }
}
// :: page "applicationQR" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "cornerOperation" Script section start. ::::::::::::::::::::::::::::::::::::::
// :: page "cornerOperation" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "entry" Script section start. ::::::::::::::::::::::::::::::::::::::
class Entry {
  display(){
    console.log('Entry.display start.');

    // 申込フォームへの遷移
    document.querySelector('.entry button').onclick = () => window.open(config.private.editURL, '_blank');

    // 受付番号表示
    document.querySelector('.entry h1').innerText = '受付番号：' + config.entryStr;

    // 参加申込フォーム誘導用QRコードのセット
    let qrcode = new QRCode(document.querySelector('.entry div'),{
      text: config.entryStr,
      width: 300,
      height: 300,
      colorDark : "#000000",
      colorLight : "#ffffff",
      correctLevel : QRCode.CorrectLevel.H
    });
    console.log('Entry.display end.');
  }
}
// :: page "entry" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "referState" Script section start. ::::::::::::::::::::::::::::::::::::::
// :: page "referState" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "information" Script section start. ::::::::::::::::::::::::::::::::::::::
// :: page "information" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "enquete" Script section start. ::::::::::::::::::::::::::::::::::::::
// :: page "enquete" Script section end. ::::::::::::::::::::::::::::::::::::::::


// :: page "system" Script section start. ::::::::::::::::::::::::::::::::::::::
  // 定期的処理の停止・再開
  // ボタンクリック時の動作を定義
  document.querySelector('.system input[name="start_stop"]').addEventListener('click',() => {
    if( !config.broadcast.intervalId || config.broadcast.intervalId === null ){
      // 停止中の場合
      config.broadcast.start();
      btn.value = '停止';
    } else {
      // 稼働中の場合
      config.broadcast.stop();
      btn.value = '再開';
    }
  });
// :: page "system" Script section end. ::::::::::::::::::::::::::::::::::::::::

window.addEventListener('DOMContentLoaded',() => {
  config.debugMode = 1; // 0:通常, 1:スタッフ, 2:参加者
  config.authorize = new Auth(()=>{ // menu/broadの初期化はconfig設定後
    // 以下、config設定が前提となる項目・画面を設定
    config.menu = new Menu();
    config.messageBoard = new messageBoard();
    config.reception = new Reception();
    config.paperForm = new PaperForm();
    config.applicationQR = new ApplicationQR();
    config.entry = new Entry();
    console.log('DOMContentLoaded end\n',config);
  });
});
</script>
</html>

