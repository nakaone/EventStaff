<!DOCTYPE html><html lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="Content-Style-Type" content="text/css">
<meta http-equiv="Content-Script-Type" content="text/javascript">
<title>paperForm</title>
<style type="text/css">
.paperForm .step1 {
  flex-direction: column;
}
</style>
</head>
<body class="paperForm">
  <div class="area step1">
    <div><p>申込者の属性を入力してください</p></div>
    <!-- 【入力欄作成時の注意事項】
      1.「(空欄)」文字列はGAS側で入力チェックに使用するので変更不可
      2.人数は「申込者」を除くフォームの参加者数と一致させる。
      3.オプションの値はフォームでの設定値と一致させる。
    -->
    <div><table>
      <tr><th>No</th><th>属性</th></tr>
      <tr><td>①</td><td><select name="n01">
        <option value="(空欄)">(空欄)</option>
        <option value="未就学児">未就学児</option>
        <option value="1年">1年</option>
        <option value="2年">2年</option>
        <option value="3年">3年</option>
        <option value="4年">4年</option>
        <option value="5年">5年</option>
        <option value="6年">6年</option>
        <option value="卒業生">卒業生</option>
        <option value="保護者">保護者</option>
      </select></td></tr>
      <tr><td>②</td><td><select name="n02">
        <option value="(空欄)">(空欄)</option>
        <option value="未就学児">未就学児</option>
        <option value="1年">1年</option>
        <option value="2年">2年</option>
        <option value="3年">3年</option>
        <option value="4年">4年</option>
        <option value="5年">5年</option>
        <option value="6年">6年</option>
        <option value="卒業生">卒業生</option>
        <option value="保護者">保護者</option>
      </select></td></tr>
      <tr><td>③</td><td><select name="n03">
        <option value="(空欄)">(空欄)</option>
        <option value="未就学児">未就学児</option>
        <option value="1年">1年</option>
        <option value="2年">2年</option>
        <option value="3年">3年</option>
        <option value="4年">4年</option>
        <option value="5年">5年</option>
        <option value="6年">6年</option>
        <option value="卒業生">卒業生</option>
        <option value="保護者">保護者</option>
      </select></td></tr>
    </table></div>
    <div><button>次へ</button></div>
  </div>

  <div class="area step2 hide">
    <h1>受付番号：</h1>
    <p>申込用紙に上の受付番号を記入の上、用紙を撮影してください</p>
    <div class="scanner"></div>
  </div>
</body>
<script type="text/javascript">
class PaperForm {
  constructor(){
    this.dom = {
      step1: document.querySelector('.paperForm .step1'),
      step2: document.querySelector('.paperForm .step2'),
    }
    this.dom.step1.querySelector('button').addEventListener('click', ()=>{
      this.getEntryNo();
    });
  }

  display(){
    config.menu.changeArea('paperForm','step1');
  }

  /** 受付番号を取得してスキャン画面を表示する
   * @param {void} - なし
   * @returns {void} なし
   */
  getEntryNo(){
    console.log('PaperForm.getEntryNo start');
    // 入力された項目をオブジェクト化
    // GAS側でszSheet.updateに直接渡せるよう、フォームの入力項目名に合わせる
    const mem = [
      {form:'参加者①所属',name:'n01'},
      {form:'参加者②所属',name:'n02'},
      {form:'参加者③所属',name:'n03'},
    ];
    const data = {PIC:config.handleName};
    for( let i=0 ; i<mem.length ; i++ ){
      const s = this.dom.step1.querySelector('select[name="'+mem[i].name+'"]');
      data[mem[i].form] = s.options[s.selectedIndex].value;
    }

    // 入力された内容をGAS.Masterに送信
    const res = fetchGAS({
      to: 'Master',
      func: 'paperForm1',
      data: data,
      callback: (r) => {
        console.log('l.109 r=',r);
        if( r.isErr ){
          alert(r.message);
        } else {
          this.scanForm(r.obj.entryNo);
        }
        console.log('PaperForm.getEntryNo end');
      },
    });
  }

  /** scanForm: 紙申請用紙を撮影し、登録する
   * @param {number} - 採番された受付番号
   * @returns {void} なし
   */
  scanForm(entryNo){
    console.log('PaperForm.scanForm start');

    // configに新規採番された受付番号を保存
    config.entryNo = entryNo;
    config.entryStr = ('000'+entryNo).slice(-4);

    // GAS.Master側で採番された受付番号を表示
    config.menu.changeArea('paperForm','step2');
    this.dom.step2.querySelector('h1').innerText = '受付番号：'+entryNo;

    // スキャナで申請用紙を撮影
    const scanner = new webScanner({
      parent: this.dom.step2.querySelector('.scanner'),
    });
    scanner.scanDoc((imageData)=>{
      // GAS.Masterに撮影された申請用紙を登録
      const res = fetchGAS({
        to: 'Master',
        func: 'paperForm2',
        data: {
          entryNo: entryNo,
          application: imageData,
        },
        callback: (r) => {
          alert(JSON.stringify(r));
          console.log('l.150',r);
          console.log('PaperForm.scanForm end');
        },
      })
    });
  }
}
</script>
</html>
