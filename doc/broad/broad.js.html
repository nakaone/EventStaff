<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: broad.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: broad.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const config = szLib.setConfig(['BroadKey']);

// ===========================================================
// トリガー関数
// ===========================================================
/** doGetTest: doGetのテスト
 * @param {*} x - なし
 * @returns void - 結果はコンソールで確認
 */
const doGetTest = () => {
  const tStr = (x) => {
    return x.toLocaleString('ja-JP') + '.' + x.getMilliseconds();
  };
  const testData = [
    {func:'postMessage',data:{
      timestamp: tStr(new Date()),
      from: '嶋津パパ',
      to: '嶋津ママ',
      message: '追加のテスト',
    }},
    {func:'getMessages',data:{}},
  ];
  for( let i=0 ; i&lt;testData.length ; i++ ){
    doGet({parameter:{v:szLib.encrypt(testData[i],config.BroadKey)}});
  }
};

/** doGet: 放送局への配信依頼受付
 * &lt;br>
 * 返値はTextOutputのインスタンス。&lt;br>
 * getContentで中の文字列を取得、parseすれば結果オブジェクトが得られる。&lt;br>
 * GAS公式: [Class TextOutput]{@link https://developers.google.com/apps-script/reference/content/text-output#getcontent}
 *
 * @param {object} e - const config = szLib.setConfig(['PostURL','PostKey']);
 * @param {object} e.parameter - パラメータ文字列
 * @param {object} e.parameter.v - グローバル変数PostKeyで暗号化された文字列。&lt;br>復号すると以下のオブジェクトとなる
 * @param {string} e.parameter.v.func - 'post'固定(他は不正)
 * @param {object} e.parameter.v.data - [postMails]{@link postMails}の引数
 * 
 * @return {object} - 正常終了の場合はpostMessage/getMessagesの戻り値。エラーの場合は空配列。
 * 
 * @example &lt;caption>引数の例&lt;/caption>
 * 放送局.doGet start. {
 *   contextPath: '',
 *   parameter: { v: 'VTJG〜E9PQ==' },
 *   parameters: { v: [ 'VTJG〜E9PQ==' ] },
 *   queryString: 'v=VTJG〜E9PQ==',
 *   contentLength: -1
 * }
 */
function doGet(e) {
  console.log('放送局.doGet start.',e);

  // 'v'で渡されたクエリを復号
  arg = szLib.decrypt(e.parameter.v,config.BroadKey);
  console.log('放送局.arg',szLib.whichType(arg),arg);

  let rv = [];
  switch( arg.func ){  // 処理指定により分岐
    case 'postMessage':  // 掲示板への投稿
      rv = postMessage(arg.data);
      break;
    case 'getMessages':  // 掲示板からメッセージの取得
      rv = getMessages();
      break;
  }

  // 結果をJSON化して返す
  rv = JSON.stringify(rv,null,2);
  console.log('放送局.doGet end.',rv);
  return ContentService
  .createTextOutput(rv)
  .setMimeType(ContentService.MimeType.JSON);
}

/** postMessage: お知らせの投稿
 * 
 * @param {object} data           - 投稿されたメッセージ
 * @param {string} data.timestamp - 投稿時刻
 * @param {string} data.from      - 発信者名
 * @param {string} data.to        - 宛先
 * @param {string} data.message   - メッセージ
 * @returns {any[]} 追加された行イメージ(一次元配列)
 */
function postMessage(data){
  console.log('放送局.postMessage start. data='+JSON.stringify(data));

  const dObj = szLib.getSheetData('ログ');
  const rv = szLib.updateSheetData(dObj,data);
  console.log('放送局.postMessage end.',JSON.stringify(rv));
  return rv;
}

/** getMessages: お知らせの取得
 * @param   {@} void - なし
 * @returns {object[]} 投稿メッセージシートの全データ
 */
function getMessages(){
  console.log('放送局.getMessages start.');

  const dObj = szLib.getSheetData('ログ');
  const rv = dObj.data;
  console.log('放送局.getMessages end. rv='+JSON.stringify(rv));
  return rv;
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#doGet">doGet</a></li><li><a href="global.html#doGetTest">doGetTest</a></li><li><a href="global.html#getMessages">getMessages</a></li><li><a href="global.html#postMessage">postMessage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.0</a> on Fri Nov 11 2022 12:18:45 GMT+0900 (日本標準時)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
